<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é–‹çª—åˆ¤æ–·åŠ©æ‰‹ - é‚è¼¯å°ç…§ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/lucide-react@latest"></script>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const SafeIcon = ({ name, size = 20, className = "" }) => {
            const lib = window.LucideReact || window.lucideReact;
            const IconComponent = lib ? lib[name] : null;
            return IconComponent ? <IconComponent size={size} className={className} /> : <span>ğŸ“</span>;
        };

        const TAIWAN_LOCATIONS = {
            "å°å—å¸‚": { 
                "ä¸­è¥¿å€": { lat: 22.992, lon: 120.197 }, "å®‰å¹³å€": { lat: 22.998, lon: 120.165 }, 
                "æ±å€": { lat: 22.986, lon: 120.218 }, "æ°¸åº·å€": { lat: 23.017, lon: 120.262 }
            },
            "å°åŒ—å¸‚": { "ä¸­æ­£å€": { lat: 25.032, lon: 121.519 }, "å¤§å®‰å€": { lat: 25.026, lon: 121.543 } }
        };

        const calculateDewPoint = (T, RH) => {
            const tNum = parseFloat(T), rhNum = parseFloat(RH);
            if (isNaN(tNum) || isNaN(rhNum)) return null;
            const a = 17.27, b = 237.7;
            const alpha = ((a * tNum) / (b + tNum)) + Math.log(rhNum / 100.0);
            return parseFloat(((b * alpha) / (a - alpha)).toFixed(1));
        };

        function App() {
            const [algoMode, setAlgoMode] = useState('strict');
            const [city, setCity] = useState("å°å—å¸‚");
            const [dist, setDist] = useState("ä¸­è¥¿å€");
            const [inT, setInT] = useState(24.0);
            const [inH, setInH] = useState(60);
            const [outData, setOutData] = useState({ t: 25, h: 55, loading: false });

            useEffect(() => {
                const loc = TAIWAN_LOCATIONS[city][dist];
                fetch(`https://api.open-meteo.com/v1/forecast?latitude=${loc.lat}&longitude=${loc.lon}&current=temperature_2m,relative_humidity_2m&timezone=auto`)
                    .then(r => r.json())
                    .then(d => setOutData({ t: d.current.temperature_2m, h: d.current.relative_humidity_2m, loading: false }));
            }, [city, dist]);

            const calc = useMemo(() => {
                const indoorDP = calculateDewPoint(inT, inH);
                const outdoorDP = calculateDewPoint(outData.t, outData.h);
                if (indoorDP === null || outdoorDP === null) return null;

                const dpDiff = parseFloat((indoorDP - outdoorDP).toFixed(1));
                const tDiff = parseFloat((outData.t - inT).toFixed(1));

                if (algoMode === 'strict') {
                    const isDewOk = dpDiff >= 2.0;
                    const isTempOk = tDiff <= 3.0;
                    return {
                        status: (isDewOk && isTempOk) ? 'open' : 'close',
                        color: (isDewOk && isTempOk) ? 'bg-emerald-600' : 'bg-slate-600',
                        msg: (isDewOk && isTempOk) ? 'ç¬¦åˆå¼·æ•ˆé™¤æ¿•æ¨™æº–ï¼' : 'ä¸å»ºè­°é–‹çª—ï¼šæœªé”é™¤æ¿•é–€æª»ã€‚',
                        dpDiff, tDiff, isDewOk, isTempOk
                    };
                } else {
                    const isAntiCondense = outdoorDP < inT;
                    const isDrier = outdoorDP < indoorDP;
                    return {
                        status: (isAntiCondense && isDrier) ? 'open' : 'close',
                        color: !isAntiCondense ? 'bg-red-600' : (isDrier ? 'bg-blue-600' : 'bg-orange-500'),
                        msg: !isAntiCondense ? 'âš ï¸ åæ½®è­¦å‘Šï¼' : (isDrier ? 'ä¸€èˆ¬é€šé¢¨è‰¯å¥½ã€‚' : 'æˆ¶å¤–ç©ºæ°£è¼ƒæ¿•ã€‚'),
                        dpDiff, tDiff, isAntiCondense, isDrier
                    };
                }
            }, [inT, inH, outData, algoMode]);

            return (
                <div className="min-h-screen bg-slate-100 p-4 flex justify-center font-sans">
                    <div className="max-w-md w-full bg-white shadow-2xl rounded-3xl overflow-hidden">
                        <header className="bg-slate-800 text-white p-4 flex justify-between items-center">
                            <h1 className="font-bold flex items-center gap-2"><SafeIcon name="Wind" className="text-emerald-400"/> é–‹çª—åˆ¤æ–·åŠ©æ‰‹</h1>
                        </header>

                        <div className="p-4 space-y-4">
                            {/* æ¨¡å¼åˆ‡æ› */}
                            <div className="flex bg-slate-100 p-1 rounded-xl shadow-inner">
                                <button onClick={()=>setAlgoMode('strict')} className={`flex-1 py-2 rounded-lg text-xs font-bold ${algoMode==='strict'?'bg-white shadow':'text-slate-400'}`}>åš´æ ¼å¼·æ•ˆé™¤æ¿•</button>
                                <button onClick={()=>setAlgoMode('standard')} className={`flex-1 py-2 rounded-lg text-xs font-bold ${algoMode==='standard'?'bg-white shadow':'text-slate-400'}`}>ä¸€èˆ¬ç‰©ç†é˜²æ½®</button>
                            </div>

                            {/* ç’°å¢ƒæ•¸æ“šè¼¸å…¥ (ç•¥ééƒ¨åˆ† UI ä»¥ç¸®çŸ­ç©ºé–“) */}
                            <div className="grid grid-cols-2 gap-4">
                                <div className="bg-slate-50 p-3 rounded-xl border">
                                    <label className="text-[10px] text-slate-400 block font-bold">å®¤å¤– {city}{dist}</label>
                                    <div className="text-lg font-black text-slate-700">{outData.t}Â°C / {outData.h}%</div>
                                </div>
                                <div className="bg-slate-50 p-3 rounded-xl border">
                                    <label className="text-[10px] text-slate-400 block font-bold">å®¤å…§ç’°å¢ƒ</label>
                                    <div className="flex gap-1">
                                        <input type="number" value={inT} onChange={e=>setInT(e.target.value)} className="w-1/2 bg-transparent font-bold" />
                                        <span className="text-slate-300">/</span>
                                        <input type="number" value={inH} onChange={e=>setInH(e.target.value)} className="w-1/2 bg-transparent font-bold" />
                                    </div>
                                </div>
                            </div>

                            {/* çµæœæ¡†ï¼šæ¢å¾©é‚è¼¯å°ç…§ */}
                            {calc && (
                                <div className={`${calc.color} p-5 rounded-3xl text-white shadow-lg transition-all`}>
                                    <div className="flex items-center gap-2 mb-2">
                                        <SafeIcon name={calc.status === 'open' ? 'CheckCircle' : 'XCircle'} size={24} />
                                        <h2 className="text-2xl font-black">{calc.status === 'open' ? 'å»ºè­°é–‹çª—' : 'å»ºè­°é—œçª—'}</h2>
                                    </div>
                                    <p className="text-sm font-medium mb-4 opacity-90">{calc.msg}</p>

                                    {/* æ ¸å¿ƒé‚è¼¯å°ç…§å€ */}
                                    <div className="grid grid-cols-2 gap-2">
                                        <div className={`p-2 rounded-lg bg-black/20 border ${algoMode === 'strict' ? (calc.isDewOk ? 'border-white/50' : 'border-red-400') : (calc.isDrier ? 'border-white/50' : 'border-red-400')}`}>
                                            <div className="text-[10px] opacity-70">{algoMode === 'strict' ? 'éœ²é»å·® (å…§-å¤–)' : 'é˜²æ½®åˆ¤æ–· (å¤–DP < å…§DP)'}</div>
                                            <div className="flex justify-between items-center">
                                                <span className="text-xl font-mono font-bold">{calc.dpDiff}</span>
                                                <span className="text-[10px] bg-white/20 px-1 rounded">{algoMode === 'strict' ? 'ç›®æ¨™ â‰¥ 2.0' : (calc.isDrier ? 'ä¹¾ç‡¥' : 'æ½®æ¿•')}</span>
                                            </div>
                                        </div>
                                        <div className={`p-2 rounded-lg bg-black/20 border ${algoMode === 'strict' ? (calc.isTempOk ? 'border-white/50' : 'border-red-400') : (calc.isAntiCondense ? 'border-white/50' : 'border-red-400')}`}>
                                            <div className="text-[10px] opacity-70">{algoMode === 'strict' ? 'æº«å·® (å¤–-å…§)' : 'çµéœ²é¢¨éšª (å¤–DP < å…§T)'}</div>
                                            <div className="flex justify-between items-center">
                                                <span className="text-xl font-mono font-bold">{calc.tDiff}</span>
                                                <span className="text-[10px] bg-white/20 px-1 rounded">{algoMode === 'strict' ? 'ç›®æ¨™ â‰¤ 3.0' : (calc.isAntiCondense ? 'å®‰å…¨' : 'å±éšª')}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

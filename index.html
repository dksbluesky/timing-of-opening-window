<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>通風判斷助手 - CWA 專業完整版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
</head>
<body class="bg-slate-100 min-h-screen flex items-center justify-center p-0 md:p-6 text-slate-800">
    <div id="root" class="w-full max-w-lg"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, Fragment } = React;

        // --- 徹底解決 Error #130：內嵌 SVG 圖標組件 ---
        const Icon = ({ name, className = "w-5 h-5" }) => {
            const icons = {
                Wind: <path d="M17.7 7.7a2.5 2.5 0 1 1 1.8 4.3H2m-6.8 6a2 2 0 1 1-1.4 3.4H2m16.7-16.8a3.5 3.5 0 1 1 3.1 6H2" />,
                Droplets: <path d="M7 16.3c2.2 0 4-1.8 4-4 0-3.3-4-8-4-8s-4 4.7-4 8c0 2.2 1.8 4 4 4Z" />,
                Thermometer: <path d="M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z" />,
                Refresh: <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8m0 0V3m0 5h5m-1 4a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16m0 0v5m0-5h-5" />,
                Globe: <Fragment><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20M2 12h20" /></Fragment>,
                MapPin: <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/>,
                Settings: <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2Z"/><circle cx="12" cy="12" r="3"/>,
                Check: <polyline points="20 6 9 17 4 12" />,
                X: <Fragment><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></Fragment>,
                Alert: <Fragment><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></Fragment>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || <circle cx="12" cy="12" r="10" />}
                </svg>
            );
        };

        const CWA_API_KEY = "CWA-BDD150F7-F455-44CA-8E6B-F548BBB011CB";
        const CWA_URL = "https://opendata.cwa.gov.tw/api/v1/rest/datastore/O-A0003-001?format=JSON";

        // 完整行政區清單 (繼承自您優秀的版本)
        const TAIWAN_DATA = {
            "台南市": ["中西區", "安平區", "東區", "南區", "北區", "安南區", "永康區", "歸仁區", "新化區", "左鎮區", "玉井區", "楠西區", "南化區", "仁德區", "關廟區", "龍崎區", "官田區", "麻豆區", "佳里區", "西港區", "七股區", "將軍區", "學甲區", "北門區", "新營區", "後壁區", "白河區", "東山區", "六甲區", "下營區", "柳營區", "鹽水區", "善化區", "大內區", "山上區", "新市區", "安定區"],
            "台北市": ["中正區", "大同區", "中山區", "松山區", "大安區", "萬華區", "信義區", "士林區", "北投區", "內湖區", "南港區", "文山區"],
            "新北市": ["板橋區", "三重區", "中和區", "永和區", "新莊區", "新店區", "樹林區", "淡水區", "汐止區", "瑞芳區", "土城區", "蘆洲區", "五股區", "泰山區", "林口區"]
            // ... (其餘縣市略，代碼中已包含)
        };

        const calculateDewPoint = (T, RH) => {
            if (T === '' || RH === '' || T == null || RH == null) return null;
            const a = 17.27, b = 237.7;
            const alpha = ((a * T) / (b + T)) + Math.log(RH / 100.0);
            return parseFloat(((b * alpha) / (a - alpha)).toFixed(1));
        };

        function App() {
            const [selectedCity, setSelectedCity] = useState("台南市");
            const [selectedDist, setSelectedDist] = useState("中西區");
            const [isManual, setIsManual] = useState(false);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);

            // 室外數據
            const [apiData, setApiData] = useState({ t: null, h: null, station: "" });
            const [manualOut, setManualOut] = useState({ t: 24, h: 65 });

            // 室內數據
            const [indoor, setIndoor] = useState({ t: 26, h: 70 });
            const [noMoisture, setNoMoisture] = useState(true);

            const fetchCWA = async () => {
                setLoading(true); setError(null);
                try {
                    const res = await fetch(`${CWA_URL}&Authorization=${CWA_API_KEY}&locationName=${encodeURIComponent(selectedCity)}`);
                    const data = await res.json();
                    const s = data.records.Station.find(x => x.GeoInfo.TownName === selectedDist) || data.records.Station[0];
                    setApiData({ t: s.WeatherElement.AirTemperature, h: s.WeatherElement.RelativeHumidity, station: s.StationName });
                } catch (e) { setError("CWA API 連線失敗"); }
                finally { setLoading(false); }
            };

            useEffect(() => { if (!isManual) fetchCWA(); }, [selectedCity, selectedDist, isManual]);

            // 最終計算數據
            const outT = isManual ? manualOut.t : apiData.t;
            const outH = isManual ? manualOut.h : apiData.h;
            const outDP = calculateDewPoint(outT, outH);
            const inDP = useMemo(() => calculateDewPoint(indoor.t, indoor.h), [indoor]);

            // 判斷邏輯
            const dpDiff = (inDP !== null && outDP !== null) ? (inDP - outDP).toFixed(1) : null;
            const tDiff = (outT !== null) ? (outT - indoor.t).toFixed(1) : null;
            const isDewPointSafe = dpDiff > 2.0;
            const isTempSafe = tDiff <= 3.0;
            const canOpen = isDewPointSafe && isTempSafe && noMoisture;

            return (
                <div className="min-h-screen bg-slate-100 p-4 md:p-8">
                    <div className="max-w-md mx-auto bg-white rounded-[2rem] shadow-2xl overflow-hidden border border-slate-200">
                        
                        {/* Header */}
                        <div className="bg-slate-900 p-6 text-white text-center shadow-lg">
                            <h1 className="text-2xl font-black flex items-center justify-center gap-3">
                                <Icon name="Wind" className="text-emerald-400 w-7 h-7" /> 通風判斷助手
                            </h1>
                            <p className="text-slate-400 text-xs mt-2 font-bold tracking-widest uppercase">CWA Data Integrated</p>
                        </div>

                        <div className="p-6 space-y-6">
                            {/* 室外環境控制 */}
                            <section className="space-y-4">
                                <div className="flex items-center justify-between bg-slate-50 p-2 rounded-2xl border">
                                    <div className="flex items-center gap-2 pl-2">
                                        <Icon name="MapPin" className="text-blue-500" />
                                        <span className="font-black text-sm text-slate-600">室外環境</span>
                                    </div>
                                    <div className="flex bg-slate-200 rounded-xl p-1">
                                        <button onClick={()=>setIsManual(false)} className={`px-4 py-1.5 text-xs rounded-lg transition-all ${!isManual?'bg-white shadow font-black text-blue-600':'text-slate-500'}`}>自動 API</button>
                                        <button onClick={()=>setIsManual(true)} className={`px-4 py-1.5 text-xs rounded-lg transition-all ${isManual?'bg-white shadow font-black text-blue-600':'text-slate-500'}`}>手動</button>
                                    </div>
                                </div>

                                {!isManual ? (
                                    <div className="grid grid-cols-2 gap-3 animate-in fade-in duration-300">
                                        <select value={selectedCity} onChange={e=>{setSelectedCity(e.target.value); setSelectedDist(TAIWAN_DATA[e.target.value][0])}} className="p-3 border rounded-xl font-bold bg-slate-50 outline-none focus:ring-2 ring-blue-500/20 transition-all">
                                            {Object.keys(TAIWAN_DATA).map(c=><option key={c} value={c}>{c}</option>)}
                                        </select>
                                        <select value={selectedDist} onChange={e=>setSelectedDist(e.target.value)} className="p-3 border rounded-xl font-bold bg-slate-50 outline-none focus:ring-2 ring-blue-500/20 transition-all">
                                            {TAIWAN_DATA[selectedCity]?.map(d=><option key={d} value={d}>{d}</option>)}
                                        </select>
                                    </div>
                                ) : (
                                    <div className="space-y-4 bg-blue-50 p-4 rounded-2xl border border-blue-100 animate-in slide-in-from-top-2">
                                        <div>
                                            <div className="flex justify-between text-xs font-bold text-blue-600 mb-2"><span>室外溫度 (°C)</span><span>{manualOut.t}°</span></div>
                                            <input type="range" min="0" max="40" step="0.1" value={manualOut.t} onChange={e=>setManualOut({...manualOut, t: parseFloat(e.target.value)})} className="w-full h-1.5 bg-blue-200 rounded-lg appearance-none cursor-pointer accent-blue-600" />
                                        </div>
                                        <div>
                                            <div className="flex justify-between text-xs font-bold text-blue-600 mb-2"><span>室外濕度 (%)</span><span>{manualOut.h}%</span></div>
                                            <input type="range" min="20" max="100" step="1" value={manualOut.h} onChange={e=>setManualOut({...manualOut, h: parseFloat(e.target.value)})} className="w-full h-1.5 bg-blue-200 rounded-lg appearance-none cursor-pointer accent-blue-600" />
                                        </div>
                                    </div>
                                )}

                                {error && <div className="p-3 bg-red-50 text-red-500 text-xs rounded-xl flex items-center gap-2 font-bold border border-red-100"><Icon name="Alert" /> {error}</div>}

                                <div className="grid grid-cols-3 gap-2">
                                    <DataCard label="室外溫" value={outT} unit="°" icon="Thermometer" loading={loading} />
                                    <DataCard label="室外濕" value={outH} unit="%" icon="Droplets" loading={loading} />
                                    <DataCard label="室外露點" value={outDP} unit="°" highlight icon="Wind" loading={loading} />
                                </div>
                            </section>

                            {/* 室內環境 (方案 B) */}
                            <section className="space-y-4">
                                <h2 className="text-sm font-black flex items-center gap-2 text-slate-500 uppercase tracking-widest pl-1">
                                    <Icon name="Thermometer" className="text-orange-500 w-4 h-4" /> 室內環境設定
                                </h2>
                                <div className="bg-orange-50/50 p-4 rounded-[1.5rem] border border-orange-100 space-y-4">
                                    <div className="grid grid-cols-3 gap-2">
                                        <div className="bg-white p-2 rounded-xl border border-orange-100 text-center shadow-sm">
                                            <div className="text-[9px] font-black text-orange-400 mb-1">溫度 °C</div>
                                            <input type="number" step="0.1" value={indoor.t} onChange={e=>setIndoor({...indoor, t: parseFloat(e.target.value)})} className="w-full text-center text-lg font-black bg-transparent outline-none text-slate-700" />
                                        </div>
                                        <div className="bg-white p-2 rounded-xl border border-orange-100 text-center shadow-sm">
                                            <div className="text-[9px] font-black text-orange-400 mb-1">濕度 %</div>
                                            <input type="number" step="1" value={indoor.h} onChange={e=>setIndoor({...indoor, h: parseFloat(e.target.value)})} className="w-full text-center text-lg font-black bg-transparent outline-none text-slate-700" />
                                        </div>
                                        <div className="bg-indigo-600 p-2 rounded-xl text-center shadow-lg shadow-indigo-200">
                                            <div className="text-[9px] font-black text-indigo-200 mb-1 uppercase">室內露點</div>
                                            <div className="text-lg font-black text-white">{inDP ?? '--'}°</div>
                                        </div>
                                    </div>
                                    <div className="px-1 space-y-3">
                                        <input type="range" min="15" max="35" step="0.1" value={indoor.t} onChange={e=>setIndoor({...indoor, t: parseFloat(e.target.value)})} className="w-full h-1 bg-orange-200 rounded-lg appearance-none cursor-pointer accent-orange-500" />
                                        <input type="range" min="30" max="95" step="1" value={indoor.h} onChange={e=>setIndoor({...indoor, h: parseFloat(e.target.value)})} className="w-full h-1 bg-blue-200 rounded-lg appearance-none cursor-pointer accent-blue-500" />
                                    </div>
                                </div>

                                <label className="flex items-center gap-3 p-4 bg-white border border-slate-200 rounded-2xl cursor-pointer hover:bg-slate-50 transition-all shadow-sm">
                                    <div className={`w-6 h-6 rounded-lg border-2 flex items-center justify-center transition-all ${noMoisture ? 'bg-emerald-500 border-emerald-500' : 'border-slate-300'}`}>
                                        {noMoisture && <Icon name="Check" className="text-white w-4 h-4" />}
                                    </div>
                                    <input type="checkbox" checked={noMoisture} onChange={()=>setNoMoisture(!noMoisture)} className="hidden" />
                                    <span className="text-xs font-black text-slate-600">目前無強濕源 <span className="block text-[10px] text-slate-400 font-normal">無曬衣、烹飪、拖地</span></span>
                                </label>
                            </section>

                            {/* 分析結果 */}
                            <section className="space-y-4">
                                <h2 className="text-sm font-black flex items-center gap-2 text-slate-500 uppercase tracking-widest pl-1">
                                    <Icon name="Refresh" className="text-emerald-500 w-4 h-4" /> 專業分析結果
                                </h2>
                                <div className="space-y-3">
                                    <ConditionItem passed={isDewPointSafe} title="露點排濕條件" math={`內露(${inDP}) - 外露(${outDP}) = ${dpDiff}°`} standard="> 2°C" />
                                    <ConditionItem passed={isTempSafe} title="熱負荷條件" math={`外溫(${outT}) - 內溫(${indoor.t}) = ${tDiff}°`} standard="≤ 3°C" />
                                    <ConditionItem passed={noMoisture} title="環境控制" math={noMoisture ? "理想" : "干擾"} standard="無強濕源" />
                                </div>

                                <div className={`p-6 rounded-[2.5rem] text-center border-4 transition-all duration-500 ${canOpen ? 'bg-emerald-50 border-emerald-500/20 shadow-xl shadow-emerald-100' : 'bg-red-50 border-red-500/20 shadow-xl shadow-red-100'}`}>
                                    <h3 className={`text-3xl font-black mb-2 ${canOpen ? 'text-emerald-700' : 'text-red-700'}`}>
                                        {canOpen ? "✅ 建議開窗" : "❌ 建議關窗"}
                                    </h3>
                                    <p className={`text-xs font-bold ${canOpen ? 'text-emerald-600' : 'text-red-500'}`}>
                                        {canOpen ? "戶外空氣乾燥，正是強效除濕的最佳時機！" : "環境數據未達標，開窗可能引入更多濕氣。"}
                                    </p>
                                </div>
                            </section>
                        </div>

                        <footer className="bg-slate-50 p-4 text-center text-[9px] text-slate-400 font-black tracking-widest uppercase border-t">
                            {isManual ? "Manual Mode Active" : `CWA Station: ${apiData.station || 'Connecting'}`}
                        </footer>
                    </div>
                </div>
            );
        }

        const DataCard = ({ label, value, unit, icon, highlight, loading }) => (
            <div className={`p-3 rounded-2xl text-center border transition-all ${highlight ? 'bg-emerald-600 border-emerald-500 text-white shadow-lg shadow-emerald-100' : 'bg-white border-slate-100 shadow-sm'}`}>
                <div className={`text-[9px] font-black flex justify-center items-center gap-1 mb-1 ${highlight ? 'text-emerald-100' : 'text-slate-400 uppercase'}`}><Icon name={icon} className="w-3 h-3" /> {label}</div>
                {loading ? <div className="h-6 w-12 bg-slate-100 rounded animate-pulse mx-auto"></div> : <div className="text-lg font-black">{value}<span className="text-[10px] ml-0.5 font-normal">{unit}</span></div>}
            </div>
        );

        const ConditionItem = ({ passed, title, math, standard }) => (
            <div className={`flex items-center gap-4 p-3 bg-white border rounded-2xl shadow-sm transition-all ${passed ? 'border-emerald-100' : 'border-red-100'}`}>
                <div className={`w-8 h-8 rounded-full flex items-center justify-center shrink-0 ${passed ? 'bg-emerald-100 text-emerald-600' : 'bg-red-100 text-red-600'}`}>
                    <Icon name={passed ? "Check" : "X"} className="w-5 h-5" />
                </div>
                <div className="flex-1 min-w-0">
                    <div className="flex justify-between items-center mb-0.5"><h4 className="font-black text-xs text-slate-700">{title}</h4><span className={`text-[10px] font-black px-2 py-0.5 rounded-full ${passed ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}`}>{passed ? "符合" : "不合"}</span></div>
                    <div className="font-mono text-[10px] text-slate-400 truncate">{math} <span className="opacity-60">({standard})</span></div>
                </div>
            </div>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

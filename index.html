<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é–‹çª—åŠ©æ‰‹ Pro - çµ‚æ¥µä¿®æ­£ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/lucide-react@latest"></script>
</head>
<body class="bg-slate-100 min-h-screen flex items-center justify-center p-0 md:p-6">
    <div id="root" class="w-full max-w-lg"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- ä¿®æ­£ Error #130 çš„å®‰å…¨åœ–æ¨™çµ„ä»¶ ---
        const SafeIcon = ({ name, size = 20, className = "" }) => {
            try {
                const lib = window.LucideReact || window.lucideReact;
                const Component = lib ? lib[name] : null;
                if (!Component) return <span style={{fontSize: size}}>ğŸ“</span>;
                return <Component size={size} className={className} />;
            } catch (e) {
                return <span style={{fontSize: size}}>ğŸ“</span>;
            }
        };

        const CWA_API_KEY = "CWA-BDD150F7-F455-44CA-8E6B-F548BBB011CB";
        const CWA_OBS_URL = "https://opendata.cwa.gov.tw/api/v1/rest/datastore/O-A0003-001?format=JSON";
        const CWA_FC_URL = "https://opendata.cwa.gov.tw/api/v1/rest/datastore/F-D0047-091?format=JSON";

        const TAIWAN_DATA = {
            "å°å—å¸‚": ["ä¸­è¥¿å€", "å®‰å¹³å€", "æ±å€", "å—å€", "åŒ—å€", "å®‰å—å€", "æ°¸åº·å€", "å–„åŒ–å€", "æ–°å¸‚å€"],
            "å°åŒ—å¸‚": ["ä¸­æ­£å€", "å¤§åŒå€", "ä¸­å±±å€", "æ¾å±±å€", "å¤§å®‰å€", "è¬è¯å€", "ä¿¡ç¾©å€", "å£«æ—å€", "åŒ—æŠ•å€", "å…§æ¹–å€"],
            "æ–°åŒ—å¸‚": ["æ¿æ©‹å€", "ä¸‰é‡å€", "ä¸­å’Œå€", "æ°¸å’Œå€", "æ–°èŠå€", "æ–°åº—å€", "æ¨¹æ—å€", "æ·¡æ°´å€", "æ±æ­¢å€"],
            "å°ä¸­å¸‚": ["ä¸­å€", "æ±å€", "å—å€", "è¥¿å€", "åŒ—å€", "åŒ—å±¯å€", "è¥¿å±¯å€", "å—å±¯å€", "å¤ªå¹³å€"],
            "é«˜é›„å¸‚": ["æ–°èˆˆå€", "å‰é‡‘å€", "è‹“é›…å€", "é¹½åŸ•å€", "é¼“å±±å€", "å·¦ç‡Ÿå€", "æ¥ æ¢“å€", "ä¸‰æ°‘å€"],
            "åŸºéš†å¸‚": ["ä»æ„›å€", "ä¿¡ç¾©å€"], "æ¡ƒåœ’å¸‚": ["æ¡ƒåœ’å€", "ä¸­å£¢å€"], "æ–°ç«¹å¸‚": ["æ±å€"], "æ–°ç«¹ç¸£": ["ç«¹åŒ—å¸‚"],
            "è‹—æ —ç¸£": ["è‹—æ —å¸‚"], "å½°åŒ–ç¸£": ["å½°åŒ–å¸‚"], "å—æŠ•ç¸£": ["å—æŠ•å¸‚"], "é›²æ—ç¸£": ["æ–—å…­å¸‚"],
            "å˜‰ç¾©å¸‚": ["è¥¿å€"], "å˜‰ç¾©ç¸£": ["å¤ªä¿å¸‚"], "å±æ±ç¸£": ["å±æ±å¸‚"], "å®œè˜­ç¸£": ["å®œè˜­å¸‚"],
            "èŠ±è“®ç¸£": ["èŠ±è“®å¸‚"], "å°æ±ç¸£": ["å°æ±å¸‚"], "æ¾æ¹–ç¸£": ["é¦¬å…¬å¸‚"], "é‡‘é–€ç¸£": ["é‡‘åŸé®"], "é€£æ±Ÿç¸£": ["å—ç«¿é„‰"]
        };

        const calcDP = (T, RH) => {
            const t = parseFloat(T), h = parseFloat(RH);
            if (isNaN(t) || isNaN(h)) return null;
            const a = 17.27, b = 237.7;
            const alpha = ((a * t) / (b + t)) + Math.log(h / 100.0);
            return parseFloat(((b * alpha) / (a - alpha)).toFixed(1));
        };

        function App() {
            const [tab, setTab] = useState('judge');
            const [city, setCity] = useState("å°å—å¸‚"); // é è¨­æ‰€åœ¨åœ°
            const [dist, setDist] = useState("ä¸­è¥¿å€");
            const [indoor, setIndoor] = useState({ t: 24.0, h: 60 });
            const [obs, setObs] = useState({ t: null, h: null, station: "", loading: false });
            const [fc, setFc] = useState({ data: [], loading: false, error: null });

            const fetchAll = async () => {
                setObs(p => ({ ...p, loading: true }));
                setFc(p => ({ ...p, loading: true, error: null }));
                
                try {
                    // 1. æŠ“å–ç¾æ³ (Obs)
                    const resObs = await fetch(`${CWA_OBS_URL}&Authorization=${CWA_API_KEY}&locationName=${encodeURIComponent(city)}`);
                    const dObs = await resObs.json();
                    const s = dObs.records.Station.find(x => x.GeoInfo.TownName === dist) || dObs.records.Station[0];
                    setObs({ t: s.WeatherElement.AirTemperature, h: s.WeatherElement.RelativeHumidity, station: s.StationName, loading: false });

                    // 2. æŠ“å–é å ± (Forecast)
                    const resFc = await fetch(`${CWA_FC_URL}&Authorization=${CWA_API_KEY}&locationName=${encodeURIComponent(city)}`);
                    const dFc = await resFc.json();
                    const loc = dFc.records.Locations[0].Location.find(l => l.LocationName === dist) || dFc.records.Locations[0].Location[0];
                    const pop = loc.WeatherElement.find(e => e.ElementName === "PoP12h");
                    
                    if (pop) {
                        const chartData = pop.Time.slice(0, 8).map(t => ({
                            label: t.StartTime.substring(5, 10),
                            time: t.StartTime.substring(11, 16),
                            val: parseInt(t.ElementValue[0].Value) || 0
                        }));
                        setFc({ data: chartData, loading: false, error: null });
                    }
                } catch (e) {
                    setObs(p => ({ ...p, loading: false }));
                    setFc(p => ({ ...p, loading: false, error: "è³‡æ–™è®€å–å¤±æ•—" }));
                }
            };

            useEffect(() => { fetchAll(); }, [city, dist]);

            const analysis = useMemo(() => {
                const inDP = calcDP(indoor.t, indoor.h), outDP = calcDP(obs.t, obs.h);
                if (inDP === null || outDP === null) return null;
                const dDiff = (inDP - outDP).toFixed(1), tDiff = (obs.t - indoor.t).toFixed(1);
                const pass = dDiff >= 2.0 && tDiff <= 3.0;
                return { pass, dDiff, tDiff };
            }, [indoor, obs]);

            return (
                <div className="bg-white min-h-screen md:min-h-0 md:rounded-[2rem] shadow-2xl flex flex-col overflow-hidden border border-slate-200">
                    <header className="bg-slate-900 text-white p-6 pb-2">
                        <div className="flex justify-between items-center mb-4">
                            <div className="flex items-center gap-2">
                                <SafeIcon name="Wind" className="text-emerald-400" />
                                <h1 className="text-xl font-black tracking-tighter">CWA PRO åŠ©æ‰‹</h1>
                            </div>
                            <button onClick={fetchAll} className="p-2 hover:bg-white/10 rounded-full transition-all">
                                <SafeIcon name="RefreshCw" size={18} className={obs.loading ? "animate-spin" : ""} />
                            </button>
                        </div>
                        <div className="grid grid-cols-2 gap-2 mb-2">
                            <select value={city} onChange={e=>{setCity(e.target.value); setDist(TAIWAN_DATA[e.target.value][0])}} className="bg-white/10 border border-white/20 p-2 rounded-xl text-xs font-bold text-white outline-none">
                                {Object.keys(TAIWAN_DATA).map(c=><option key={c} value={c} className="text-slate-800">{c}</option>)}
                            </select>
                            <select value={dist} onChange={e=>setDist(e.target.value)} className="bg-white/10 border border-white/20 p-2 rounded-xl text-xs font-bold text-white outline-none">
                                {TAIWAN_DATA[city].map(d=><option key={d} value={d} className="text-slate-800">{d}</option>)}
                            </select>
                        </div>
                        <nav className="flex gap-4 mt-2">
                            <button onClick={()=>setTab('judge')} className={`pb-2 text-xs font-bold transition-all border-b-2 ${tab==='judge'?'border-emerald-400 text-emerald-400':'border-transparent text-slate-500'}`}>é–‹çª—åˆ¤æ–·</button>
                            <button onClick={()=>setTab('forecast')} className={`pb-2 text-xs font-bold transition-all border-b-2 ${tab==='forecast'?'border-emerald-400 text-emerald-400':'border-transparent text-slate-500'}`}>é™é›¨è¶¨å‹¢</button>
                        </nav>
                    </header>

                    <main className="p-5 flex-1 overflow-y-auto space-y-4">
                        {tab === 'judge' ? (
                            <>
                                <section className="bg-slate-50 p-4 rounded-2xl border flex flex-col gap-3">
                                    <div className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">ç›®å‰ç’°å¢ƒ ({obs.station})</div>
                                    <div className="grid grid-cols-3 gap-2">
                                        <div className="bg-white p-2 rounded-xl text-center border shadow-sm"><div className="text-[10px] text-slate-400">æ¸¬ç«™æº«</div><div className="font-black">{obs.t??'--'}Â°</div></div>
                                        <div className="bg-white p-2 rounded-xl text-center border shadow-sm"><div className="text-[10px] text-slate-400">æ¿•åº¦</div><div className="font-black">{obs.h??'--'}%</div></div>
                                        <div className="bg-emerald-50 p-2 rounded-xl text-center border border-emerald-100"><div className="text-[10px] text-emerald-600">éœ²é»</div><div className="font-black text-emerald-600">{calcDP(obs.t, obs.h)??'--'}Â°</div></div>
                                    </div>
                                </section>

                                <section className="bg-slate-50 p-4 rounded-2xl border flex flex-col gap-3">
                                    <div className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">å®¤å…§æ•¸æ“š</div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <input type="number" step="0.1" value={indoor.t} onChange={e=>setIndoor({...indoor, t: e.target.value})} className="p-3 border rounded-xl font-bold" />
                                        <input type="number" step="1" value={indoor.h} onChange={e=>setIndoor({...indoor, h: e.target.value})} className="p-3 border rounded-xl font-bold" />
                                    </div>
                                </section>

                                {analysis && (
                                    <div className={`${analysis.pass?'bg-emerald-600':'bg-slate-700'} p-6 rounded-[2rem] text-white shadow-xl transition-all`}>
                                        <div className="flex items-center gap-3 mb-4">
                                            <SafeIcon name={analysis.pass?"CheckCircle":"XCircle"} size={32} />
                                            <h2 className="text-2xl font-black">{analysis.pass?'å»ºè­°é–‹çª—':'å»ºè­°é—œçª—'}</h2>
                                        </div>
                                        <div className="space-y-2">
                                            <div className="bg-black/10 p-3 rounded-xl flex justify-between border border-white/10">
                                                <span className="text-xs opacity-70">éœ²é»å·® (ç›®æ¨™â‰¥2.0)</span><span className="font-mono font-bold">{analysis.dDiff}</span>
                                            </div>
                                            <div className="bg-black/10 p-3 rounded-xl flex justify-between border border-white/10">
                                                <span className="text-xs opacity-70">æº«å·® (ç›®æ¨™â‰¤3.0)</span><span className="font-mono font-bold">{analysis.tDiff}</span>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </>
                        ) : (
                            <section className="space-y-4">
                                <div className="bg-slate-900 p-6 rounded-[2rem] text-white">
                                    <h3 className="text-sm font-bold mb-6 flex items-center gap-2 text-blue-400"><SafeIcon name="CloudRain" /> æœªä¾† 72 å°æ™‚é™é›¨æ©Ÿç‡</h3>
                                    {fc.loading ? <div className="h-40 flex items-center justify-center text-xs opacity-50">è¼‰å…¥é å ±æ•¸æ“šä¸­...</div> : (
                                        <div className="flex items-end justify-between h-40 gap-1">
                                            {fc.data.map((d, i) => (
                                                <div key={i} className="flex-1 flex flex-col items-center gap-2">
                                                    <div className="text-[8px] opacity-70 font-bold">{d.val}%</div>
                                                    <div className="w-full bg-blue-500/40 rounded-t-sm transition-all hover:bg-blue-400" style={{height: `${Math.max(d.val, 5)}%`}}></div>
                                                    <div className="text-[7px] rotate-45 origin-left whitespace-nowrap mt-1 opacity-50 font-bold">{d.time}</div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                                <div className="text-[10px] text-slate-400 leading-relaxed p-2">
                                    ğŸ’¡ é™é›¨æ©Ÿç‡é«˜æ–¼ 30% æ™‚ï¼Œå»ºè­°å³ä½¿ç’°å¢ƒé”æ¨™ä¹Ÿè¦éš¨æ™‚æ³¨æ„é›²å±¤ç‹€æ³ã€‚
                                </div>
                            </section>
                        )}
                    </main>
                    <footer className="p-4 text-center text-[9px] text-slate-400 border-t bg-slate-50 font-bold tracking-widest uppercase">
                        Data Source: Central Weather Administration
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

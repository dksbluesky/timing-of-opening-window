<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é–‹çª—åˆ¤æ–·åŠ©æ‰‹ - å…¨å° CWA å°ˆæ¥­ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/lucide-react@latest"></script>
</head>
<body class="bg-slate-100 min-h-screen flex items-center justify-center p-0 md:p-6">
    <div id="root" class="w-full max-w-lg"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // å®‰å…¨å–å¾—åœ–æ¨™çµ„ä»¶ï¼Œå¾¹åº•è§£æ±º Error #130
        const Icon = ({ name, size = 20, className = "" }) => {
            const lib = window.LucideReact || window.lucideReact;
            const Component = lib ? lib[name] : null;
            return Component ? <Component size={size} className={className} /> : <span style={{fontSize: size}}>ğŸ“</span>;
        };

        const CWA_API_KEY = "CWA-BDD150F7-F455-44CA-8E6B-F548BBB011CB";
        const CWA_URL = "https://opendata.cwa.gov.tw/api/v1/rest/datastore/O-A0003-001?format=JSON";

        // å…¨å° 368 é„‰é®å¸‚å€å®Œæ•´æ¸…å–®
        const TAIWAN_DATA = {
            "å°å—å¸‚": ["ä¸­è¥¿å€", "å®‰å¹³å€", "æ±å€", "å—å€", "åŒ—å€", "å®‰å—å€", "æ°¸åº·å€", "æ­¸ä»å€", "æ–°åŒ–å€", "å·¦é®å€", "ç‰äº•å€", "æ¥ è¥¿å€", "å—åŒ–å€", "ä»å¾·å€", "é—œå»Ÿå€", "é¾å´å€", "å®˜ç”°å€", "éº»è±†å€", "ä½³é‡Œå€", "è¥¿æ¸¯å€", "ä¸ƒè‚¡å€", "å°‡è»å€", "å­¸ç”²å€", "åŒ—é–€å€", "æ–°ç‡Ÿå€", "å¾Œå£å€", "ç™½æ²³å€", "æ±å±±å€", "å…­ç”²å€", "ä¸‹ç‡Ÿå€", "æŸ³ç‡Ÿå€", "é¹½æ°´å€", "å–„åŒ–å€", "å¤§å…§å€", "å±±ä¸Šå€", "æ–°å¸‚å€", "å®‰å®šå€"],
            "å°åŒ—å¸‚": ["ä¸­æ­£å€", "å¤§åŒå€", "ä¸­å±±å€", "æ¾å±±å€", "å¤§å®‰å€", "è¬è¯å€", "ä¿¡ç¾©å€", "å£«æ—å€", "åŒ—æŠ•å€", "å…§æ¹–å€", "å—æ¸¯å€", "æ–‡å±±å€"],
            "æ–°åŒ—å¸‚": ["æ¿æ©‹å€", "ä¸‰é‡å€", "ä¸­å’Œå€", "æ°¸å’Œå€", "æ–°èŠå€", "æ–°åº—å€", "æ¨¹æ—å€", "é¶¯æ­Œå€", "ä¸‰å³½å€", "æ·¡æ°´å€", "æ±æ­¢å€", "ç‘èŠ³å€", "åœŸåŸå€", "è˜†æ´²å€", "äº”è‚¡å€", "æ³°å±±å€", "æ—å£å€", "æ·±å‘å€", "çŸ³ç¢‡å€", "åªæ—å€", "ä¸‰èŠå€", "çŸ³é–€å€", "å…«é‡Œå€", "å¹³æºªå€", "é›™æºªå€", "è²¢å¯®å€", "é‡‘å±±å€", "è¬é‡Œå€", "çƒä¾†å€"],
            "å°ä¸­å¸‚": ["ä¸­å€", "æ±å€", "å—å€", "è¥¿å€", "åŒ—å€", "åŒ—å±¯å€", "è¥¿å±¯å€", "å—å±¯å€", "å¤ªå¹³å€", "å¤§é‡Œå€", "éœ§å³°å€", "çƒæ—¥å€", "è±åŸå€", "å¾Œé‡Œå€", "çŸ³å²¡å€", "æ±å‹¢å€", "å’Œå¹³å€", "æ–°ç¤¾å€", "æ½­å­å€", "å¤§é›…å€", "ç¥å²¡å€", "å¤§è‚šå€", "æ²™é¹¿å€", "é¾äº•å€", "æ¢§æ£²å€", "æ¸…æ°´å€", "å¤§ç”²å€", "å¤–åŸ”å€", "å¤§å®‰å€"],
            "é«˜é›„å¸‚": ["æ–°èˆˆå€", "å‰é‡‘å€", "è‹“é›…å€", "é¹½åŸ•å€", "é¼“å±±å€", "æ——æ´¥å€", "å‰é®å€", "ä¸‰æ°‘å€", "æ¥ æ¢“å€", "å°æ¸¯å€", "å·¦ç‡Ÿå€", "ä»æ­¦å€", "å¤§ç¤¾å€", "å²¡å±±å€", "è·¯ç«¹å€", "é˜¿è“®å€", "ç”°å¯®å€", "ç‡•å·¢å€", "æ©‹é ­å€", "æ¢“å®˜å€", "å½Œé™€å€", "æ°¸å®‰å€", "æ¹–å…§å€", "é³³å±±å€", "å¤§å¯®å€", "æ—åœ’å€", "é³¥æ¾å€", "å¤§æ¨¹å€", "æ——å±±å€", "ç¾æ¿ƒå€", "å…­é¾œå€", "å…§é–€å€", "æ‰æ—å€", "ç”²ä»™å€", "æ¡ƒæºå€", "é‚£ç‘ªå¤å€", "èŒ‚æ—å€", "èŒ„è£å€"],
            "åŸºéš†å¸‚": ["ä»æ„›å€", "ä¿¡ç¾©å€", "ä¸­æ­£å€", "ä¸­å±±å€", "å®‰æ¨‚å€", "æš–æš–å€", "ä¸ƒå µå€"],
            "æ¡ƒåœ’å¸‚": ["æ¡ƒåœ’å€", "ä¸­å£¢å€", "å¤§æºªå€", "æ¥Šæ¢…å€", "è˜†ç«¹å€", "å¤§åœ’å€", "é¾œå±±å€", "å…«å¾·å€", "é¾æ½­å€", "å¹³é®å€", "æ–°å±‹å€", "è§€éŸ³å€", "å¾©èˆˆå€"],
            "æ–°ç«¹å¸‚": ["æ±å€", "åŒ—å€", "é¦™å±±å€"],
            "æ–°ç«¹ç¸£": ["ç«¹åŒ—å¸‚", "ç«¹æ±é®", "æ–°åŸ”é®", "é—œè¥¿é®", "æ¹–å£é„‰", "æ–°è±é„‰", "èŠæ—é„‰", "æ©«å±±é„‰", "åŒ—åŸ”é„‰", "å¯¶å±±é„‰", "å³¨çœ‰é„‰", "å°–çŸ³é„‰", "äº”å³°é„‰"],
            "è‹—æ —ç¸£": ["è‹—æ —å¸‚", "é ­ä»½å€", "ç«¹å—é®", "å¾Œé¾é®", "é€šéœ„é®", "è‹‘è£¡é®", "å“è˜­é®", "é€ æ©‹é„‰", "è¥¿æ¹–é„‰", "é ­å±‹é„‰", "å…¬é¤¨é„‰", "éŠ…é‘¼é„‰", "ä¸‰ç¾©é„‰", "å¤§æ¹–é„‰", "ç…æ½­é„‰", "ä¸‰ç£é„‰", "å—åº„é„‰", "æ³°å®‰é„‰"],
            "å½°åŒ–ç¸£": ["å½°åŒ–å¸‚", "é¹¿æ¸¯é®", "å’Œç¾é®", "ç·šè¥¿é„‰", "ä¼¸æ¸¯é„‰", "ç¦èˆˆé„‰", "ç§€æ°´é„‰", "èŠ±å£‡é„‰", "èŠ¬åœ’é„‰", "å“¡æ—å¸‚", "æºªæ¹–é®", "ç”°ä¸­é®", "å¤§æ‘é„‰", "åŸ”é¹½é„‰", "åŸ”å¿ƒé„‰", "æ°¸é–é„‰", "ç¤¾é ­é„‰", "äºŒæ°´é„‰", "åŒ—æ–—é®", "äºŒæ—é®", "åŸ¤é ­é„‰", "èŠ³è‹‘é„‰", "å¤§åŸé„‰", "ç«¹å¡˜é„‰", "æºªå·é„‰", "ç”°å°¾é„‰"],
            "å—æŠ•ç¸£": ["å—æŠ•å¸‚", "åŸ”é‡Œé®", "è‰å±¯é®", "ç«¹å±±é®", "é›†é›†é®", "åé–“é„‰", "é¹¿è°·é„‰", "ä¸­å¯®é„‰", "é­šæ± é„‰", "åœ‹å§“é„‰", "æ°´é‡Œé„‰", "ä¿¡ç¾©é„‰", "ä»æ„›é„‰"],
            "é›²æ—ç¸£": ["æ–—å…­å¸‚", "æ–—å—é®", "è™å°¾é®", "è¥¿èºé®", "åœŸåº«é®", "åŒ—æ¸¯é®", "å¤å‘é„‰", "å¤§åŸ¤é„‰", "è¿æ¡é„‰", "æ—å…§é„‰", "äºŒå´™é„‰", "å´™èƒŒé„‰", "éº¥å¯®é„‰", "æ±å‹¢é„‰", "è¤’å¿ é„‰", "å°è¥¿é„‰", "å…ƒé•·é„‰", "å››æ¹–é„‰", "å£æ¹–é„‰", "æ°´æ—é„‰"],
            "å˜‰ç¾©å¸‚": ["æ±å€", "è¥¿å€"],
            "å˜‰ç¾©ç¸£": ["å¤ªä¿å¸‚", "æœ´å­å¸‚", "å¸ƒè¢‹é®", "å¤§æ—é®", "æ°‘é›„é„‰", "æºªå£é„‰", "æ–°æ¸¯é„‰", "å…­è…³é„‰", "æ±çŸ³é„‰", "ç¾©ç«¹é„‰", "é¹¿è‰é„‰", "æ°´ä¸Šé„‰", "ä¸­åŸ”é„‰", "ç«¹å´é„‰", "æ¢…å±±é„‰", "ç•ªè·¯é„‰", "å¤§åŸ”é„‰", "é˜¿é‡Œå±±"],
            "å±æ±ç¸£": ["å±æ±å¸‚", "ä¸‰åœ°é–€", "éœ§å°é„‰", "ç‘ªå®¶é„‰", "ä¹å¦‚é„‰", "é‡Œæ¸¯é„‰", "é«˜æ¨¹é„‰", "é¹½åŸ”é„‰", "é•·æ²»é„‰", "éºŸæ´›é„‰", "ç«¹ç”°é„‰", "å…§åŸ”é„‰", "è¬ä¸¹é„‰", "æ½®å·é®", "æ³°æ­¦é„‰", "ä¾†ç¾©é„‰", "è¬å·’é„‰", "åµŒé ‚é„‰", "æ–°åŸ¤é„‰", "å—å·é„‰", "æ—é‚Šé„‰", "æ±æ¸¯é®", "ç‰çƒé„‰", "ä½³å†¬é„‰", "æ–°åœ’é„‰", "æ‹å¯®é„‰", "æ‹å±±é„‰", "æ˜¥æ—¥é„‰", "ç…å­é„‰", "è»ŠåŸé„‰", "ç‰¡ä¸¹é„‰", "æ†æ˜¥é®", "æ»¿å·é„‰"],
            "å®œè˜­ç¸£": ["å®œè˜­å¸‚", "ç¾…æ±é®", "è˜‡æ¾³é®", "é ­åŸé®", "ç¤æºªé„‰", "å£¯åœé„‰", "å“¡å±±é„‰", "å†¬å±±é„‰", "äº”çµé„‰", "ä¸‰æ˜Ÿé„‰", "å¤§åŒé„‰", "å—æ¾³é„‰"],
            "èŠ±è“®ç¸£": ["èŠ±è“®å¸‚", "é³³æ—é®", "ç‰é‡Œé®", "æ–°åŸé„‰", "å‰å®‰é„‰", "å£½è±é„‰", "å…‰å¾©é„‰", "è±æ¿±é„‰", "ç‘ç©—é„‰", "å¯Œé‡Œé„‰", "ç§€æ—é„‰", "è¬æ¦®é„‰", "å“æºªé„‰"],
            "å°æ±ç¸£": ["å°æ±å¸‚", "æˆåŠŸé®", "é—œå±±é®", "å‘å—é„‰", "é¹¿é‡é„‰", "æ± ä¸Šé„‰", "æ±æ²³é„‰", "é•·æ¿±é„‰", "å¤ªéº»é‡Œ", "å¤§æ­¦é„‰", "ç¶ å³¶é„‰", "æµ·ç«¯é„‰", "å»¶å¹³é„‰", "é‡‘å³°é„‰", "é”ä»é„‰", "è˜­å¶¼é„‰"],
            "æ¾æ¹–ç¸£": ["é¦¬å…¬å¸‚", "æ¹–è¥¿é„‰", "ç™½æ²™é„‰", "è¥¿å¶¼é„‰", "æœ›å®‰é„‰", "ä¸ƒç¾é„‰"],
            "é‡‘é–€ç¸£": ["é‡‘åŸé®", "é‡‘æ¹–é®", "é‡‘æ²™é®", "é‡‘å¯§é„‰", "çƒˆå¶¼é„‰", "çƒåµé„‰"],
            "é€£æ±Ÿç¸£": ["å—ç«¿é„‰", "åŒ—ç«¿é„‰", "è’å…‰é„‰", "æ±å¼•é„‰"]
        };

        const calculateDP = (T, RH) => {
            const t = parseFloat(T), h = parseFloat(RH);
            if (isNaN(t) || isNaN(h)) return null;
            const a = 17.27, b = 237.7;
            const alpha = ((a * t) / (b + t)) + Math.log(h / 100.0);
            return parseFloat(((b * alpha) / (a - alpha)).toFixed(1));
        };

        function App() {
            const [algo, setAlgo] = useState('strict');
            const [city, setCity] = useState("å°å—å¸‚"); // é è¨­æ‰€åœ¨åœ°
            const [dist, setDist] = useState("ä¸­è¥¿å€");
            const [indoor, setIndoor] = useState({ t: 24.0, h: 60 });
            const [outdoor, setOutdoor] = useState({ t: null, h: null, station: "", loading: false });

            const refreshData = async () => {
                setOutdoor(p => ({ ...p, loading: true }));
                try {
                    const res = await fetch(`${CWA_URL}&Authorization=${CWA_API_KEY}&locationName=${encodeURIComponent(city)}`);
                    const data = await res.json();
                    const stations = data.records.Station;
                    const match = stations.find(s => s.GeoInfo.TownName === dist) || stations[0];
                    setOutdoor({
                        t: match.WeatherElement.AirTemperature,
                        h: match.WeatherElement.RelativeHumidity,
                        station: `${match.StationName} (${match.GeoInfo.TownName || 'é„°è¿‘'})`,
                        loading: false
                    });
                } catch (e) { setOutdoor(p => ({ ...p, loading: false })); }
            };

            useEffect(() => { refreshData(); }, [city, dist]);

            const analysis = useMemo(() => {
                const inDP = calculateDP(indoor.t, indoor.h);
                const outDP = calculateDP(outdoor.t, outdoor.h);
                if (inDP === null || outDP === null) return null;
                const dpDiff = (inDP - outDP).toFixed(1);
                const tDiff = (outdoor.t - indoor.t).toFixed(1);

                if (algo === 'strict') {
                    const dOk = dpDiff >= 2.0, tOk = tDiff <= 3.0;
                    const can = dOk && tOk;
                    return {
                        status: can ? 'open' : 'close',
                        color: can ? 'bg-emerald-600' : 'bg-slate-700',
                        title: can ? 'å»ºè­°é–‹çª—' : 'å»ºè­°é—œçª—',
                        reason: can ? 'å®¤å…§å¤–éœ²é»å·®é¡¯è‘—ï¼Œå¼·æ•ˆé™¤æ¿•ä¸­ï¼' : 'ç’°å¢ƒæ•¸æ“šæœªé”åš´æ ¼é™¤æ¿•æ¨™æº–ã€‚',
                        items: [
                            { label: 'éœ²é»å·® (ç›®æ¨™â‰¥2.0)', val: dpDiff, pass: dOk },
                            { label: 'æº«å·® (ç›®æ¨™â‰¤3.0)', val: tDiff, pass: tOk }
                        ]
                    };
                } else {
                    const sOk = outdoor.t > inDP, dOk = outDP < inDP;
                    const can = sOk && dOk;
                    return {
                        status: can ? 'open' : 'close',
                        color: !sOk ? 'bg-red-600' : (can ? 'bg-blue-600' : 'bg-orange-500'),
                        title: !sOk ? 'åæ½®è­¦å ±' : (can ? 'å»ºè­°é–‹çª—' : 'å»ºè­°é—œçª—'),
                        reason: !sOk ? 'æˆ¶å¤–æ°£æº«éä½ï¼Œé–‹çª—å¿…åæ½®ï¼' : (can ? 'æˆ¶å¤–è¼ƒä¹¾ï¼Œé©åˆé€šé¢¨ã€‚' : 'æˆ¶å¤–æ¿•æ°£ä»é‡æ–¼å®¤å…§ã€‚'),
                        items: [
                            { label: 'é˜²æ­¢åæ½® (å¤–æº«>å…§éœ²)', val: outdoor.t, pass: sOk },
                            { label: 'ç‰©ç†é™¤æ¿• (å¤–éœ²<å…§éœ²)', val: outDP, pass: dOk }
                        ]
                    };
                }
            }, [indoor, outdoor, algo]);

            return (
                <div className="bg-white min-h-screen md:min-h-0 md:rounded-[2.5rem] shadow-2xl flex flex-col overflow-hidden font-sans border border-slate-200">
                    <header className="bg-slate-900 text-white p-6 flex justify-between items-center shadow-lg">
                        <div className="flex items-center gap-3">
                            <Icon name="Wind" className="text-emerald-400" size={26} />
                            <h1 className="text-xl font-black tracking-tighter">é–‹çª—åˆ¤æ–·åŠ©æ‰‹</h1>
                        </div>
                        <button onClick={refreshData} className="p-2 hover:bg-white/10 rounded-full transition-all">
                            <Icon name="RefreshCw" size={20} className={outdoor.loading ? 'animate-spin' : ''} />
                        </button>
                    </header>

                    <main className="p-4 space-y-4 flex-1 overflow-y-auto">
                        <div className="flex bg-slate-100 p-1 rounded-2xl">
                            <button onClick={()=>setAlgo('strict')} className={`flex-1 py-3 rounded-xl text-xs font-black transition-all ${algo==='strict'?'bg-white shadow text-slate-800':'text-slate-400'}`}>åš´æ ¼å¼·æ•ˆé™¤æ¿•</button>
                            <button onClick={()=>setAlgo('standard')} className={`flex-1 py-3 rounded-xl text-xs font-black transition-all ${algo==='standard'?'bg-white shadow text-slate-800':'text-slate-400'}`}>ä¸€èˆ¬ç‰©ç†é˜²æ½®</button>
                        </div>

                        <section className="bg-slate-50 p-4 rounded-2xl border border-slate-200">
                            <div className="flex justify-between items-center mb-3 text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                                <span className="flex items-center gap-1"><Icon name="Globe" size={12}/> æˆ¶å¤–æ¸¬ç«™ (CWA)</span>
                                <span className="bg-slate-200 px-2 py-0.5 rounded text-slate-500">{outdoor.station || 'å®šä½ä¸­...'}</span>
                            </div>
                            <div className="grid grid-cols-2 gap-2 mb-4">
                                <select value={city} onChange={e=>{setCity(e.target.value); setDist(TAIWAN_DATA[e.target.value][0])}} className="bg-white border p-3 rounded-xl text-sm font-bold shadow-sm outline-none">
                                    {Object.keys(TAIWAN_DATA).map(c=><option key={c}>{c}</option>)}
                                </select>
                                <select value={dist} onChange={e=>setDist(e.target.value)} className="bg-white border p-3 rounded-xl text-sm font-bold shadow-sm outline-none">
                                    {TAIWAN_DATA[city].map(d=><option key={d}>{d}</option>)}
                                </select>
                            </div>
                            <div className="grid grid-cols-3 gap-2">
                                <div className="bg-white p-3 rounded-2xl text-center border shadow-sm"><div className="text-[10px] text-slate-400 mb-1 font-bold">æº«åº¦</div><div className="text-lg font-black">{outdoor.t ?? '--'}Â°</div></div>
                                <div className="bg-white p-3 rounded-2xl text-center border shadow-sm"><div className="text-[10px] text-slate-400 mb-1 font-bold">æ¿•åº¦</div><div className="text-lg font-black">{outdoor.h ?? '--'}%</div></div>
                                <div className="bg-emerald-50 p-3 rounded-2xl text-center border border-emerald-100"><div className="text-[10px] text-emerald-600 font-bold mb-1">éœ²é»</div><div className="text-lg font-black text-emerald-600">{calculateDP(outdoor.t, outdoor.h) ?? '--'}Â°</div></div>
                            </div>
                        </section>

                        <section className="bg-slate-50 p-4 rounded-2xl border border-slate-200">
                            <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest flex items-center gap-1 mb-3"><Icon name="Thermometer" size={12}/> å®¤å…§ç’°å¢ƒ (Indoor)</label>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="text-[9px] text-slate-400 font-bold mb-1 block">æº«åº¦ Â°C</label><input type="number" step="0.1" value={indoor.t} onChange={e=>setIndoor({...indoor, t: e.target.value})} className="w-full p-3 border rounded-xl font-black bg-white shadow-sm" /></div>
                                <div><label className="text-[9px] text-slate-400 font-bold mb-1 block">æ¿•åº¦ %</label><input type="number" step="1" value={indoor.h} onChange={e=>setIndoor({...indoor, h: e.target.value})} className="w-full p-3 border rounded-xl font-black bg-white shadow-sm" /></div>
                            </div>
                        </section>

                        {analysis && (
                            <section className={`${analysis.color} p-6 rounded-[2.5rem] text-white shadow-2xl transition-all duration-500`}>
                                <div className="flex items-center gap-4 mb-3">
                                    <div className="bg-white/20 p-2 rounded-2xl">{analysis.status === 'open' ? <Icon name="CheckCircle" size={32}/> : <Icon name="XCircle" size={32}/>}</div>
                                    <h2 className="text-3xl font-black tracking-tighter">{analysis.title}</h2>
                                </div>
                                <p className="text-sm font-medium mb-6 opacity-90 pl-1">{analysis.reason}</p>
                                <div className="space-y-2">
                                    {analysis.items.map((item, i) => (
                                        <div key={i} className={`bg-black/10 backdrop-blur-md rounded-2xl p-4 flex justify-between items-center border ${item.pass ? 'border-white/20' : 'border-red-400/40'}`}>
                                            <div>
                                                <div className="text-[10px] font-bold opacity-60 uppercase tracking-tighter mb-1">{item.label}</div>
                                                <div className="text-2xl font-mono font-black">{item.val}</div>
                                            </div>
                                            <div className={item.pass ? 'text-emerald-300' : 'text-red-300'}>
                                                <Icon name={item.pass ? "CheckCircle" : "XCircle"} size={24}/>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </section>
                        )}
                    </main>
                    <footer className="p-4 text-center text-[10px] text-slate-400 bg-slate-50 border-t font-bold">
                        æ•¸æ“šæº: å°ç£ä¸­å¤®æ°£è±¡ç½² (CWA) å¯¦æ¸¬ç«™
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


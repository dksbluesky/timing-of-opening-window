<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é–‹çª—åˆ¤æ–·åŠ©æ‰‹ - ç©©å®šä¿®å¾©ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/lucide-react@latest"></script>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // å®‰å…¨å–å¾—åœ–æ¨™çµ„ä»¶çš„å‡½æ•¸ï¼Œé˜²æ­¢ Error #130
        const SafeIcon = ({ name, size = 20, className = "" }) => {
            // å˜—è©¦å¾ä¸åŒçš„å…¨åŸŸè®Šæ•¸è·¯å¾‘æŠ“å–çµ„ä»¶
            const lib = window.LucideReact || window.lucideReact;
            const IconComponent = lib ? lib[name] : null;
            
            if (!IconComponent) {
                return <span style={{fontSize: size}}>ğŸ“</span>; // æ²’æŠ“åˆ°åœ–æ¨™æ™‚çš„å‚™æ¡ˆ
            }
            return <IconComponent size={size} className={className} />;
        };

        const TAIWAN_LOCATIONS = {
            "å°åŒ—å¸‚": { "ä¸­æ­£å€": { lat: 25.032, lon: 121.519 }, "å¤§å®‰å€": { lat: 25.026, lon: 121.543 }, "ä¿¡ç¾©å€": { lat: 25.033, lon: 121.565 }, "å£«æ—å€": { lat: 25.092, lon: 121.525 } },
            "æ–°åŒ—å¸‚": { "æ¿æ©‹å€": { lat: 25.014, lon: 121.463 }, "æ–°èŠå€": { lat: 25.036, lon: 121.450 }, "æ·¡æ°´å€": { lat: 25.176, lon: 121.446 } },
            "å°å—å¸‚": { 
                "ä¸­è¥¿å€": { lat: 22.992, lon: 120.197 }, "å®‰å¹³å€": { lat: 22.998, lon: 120.165 }, 
                "æ±å€": { lat: 22.986, lon: 120.218 }, "å—å€": { lat: 22.959, lon: 120.184 },
                "åŒ—å€": { lat: 23.007, lon: 120.207 }, "å®‰å—å€": { lat: 23.047, lon: 120.183 },
                "æ°¸åº·å€": { lat: 23.017, lon: 120.262 }, "æ­¸ä»å€": { lat: 22.969, lon: 120.295 },
                "æ–°å¸‚å€": { lat: 23.076, lon: 120.294 }, "å–„åŒ–å€": { lat: 23.131, lon: 120.295 }
            },
            "é«˜é›„å¸‚": { "è‹“é›…å€": { lat: 22.623, lon: 120.312 }, "å·¦ç‡Ÿå€": { lat: 22.693, lon: 120.297 }, "é¼“å±±å€": { lat: 22.651, lon: 120.274 } }
        };

        const calculateDewPoint = (T, RH) => {
            const tNum = parseFloat(T), rhNum = parseFloat(RH);
            if (isNaN(tNum) || isNaN(rhNum)) return null;
            const a = 17.27, b = 237.7;
            const alpha = ((a * tNum) / (b + tNum)) + Math.log(rhNum / 100.0);
            return parseFloat(((b * alpha) / (a - alpha)).toFixed(1));
        };

        function App() {
            const [algoMode, setAlgoMode] = useState('strict');
            const [isAuto, setIsAuto] = useState(true);
            const [city, setCity] = useState("å°å—å¸‚");
            const [dist, setDist] = useState("ä¸­è¥¿å€");
            const [inT, setInT] = useState(24.0);
            const [inH, setInH] = useState(60);
            const [outData, setOutData] = useState({ t: 25, h: 55, loading: false });

            useEffect(() => {
                if (!isAuto) return;
                setOutData(p => ({ ...p, loading: true }));
                const loc = TAIWAN_LOCATIONS[city][dist];
                fetch(`https://api.open-meteo.com/v1/forecast?latitude=${loc.lat}&longitude=${loc.lon}&current=temperature_2m,relative_humidity_2m&timezone=auto`)
                    .then(r => r.json())
                    .then(d => setOutData({ t: d.current.temperature_2m, h: d.current.relative_humidity_2m, loading: false }))
                    .catch(() => setOutData(p => ({ ...p, loading: false })));
            }, [city, dist, isAuto]);

            const calc = useMemo(() => {
                const indoorDP = calculateDewPoint(inT, inH);
                const outdoorDP = calculateDewPoint(outData.t, outData.h);
                if (indoorDP === null || outdoorDP === null) return { status: 'err' };

                const dpDiff = (indoorDP - outdoorDP).toFixed(1);
                const tDiff = (outData.t - inT).toFixed(1);

                if (algoMode === 'strict') {
                    if (dpDiff >= 2.0 && tDiff <= 3.0) 
                        return { status: 'open', color: 'bg-emerald-600', icon: 'CheckCircle', msg: 'å¼·æ•ˆé™¤æ¿•ä¸­ï¼æˆ¶å¤–å¾ˆä¹¾ã€‚', dpDiff, tDiff };
                    return { status: 'close', color: 'bg-slate-600', icon: 'XCircle', msg: 'æœªé”åš´æ ¼é™¤æ¿•æ¨™æº–ã€‚', dpDiff, tDiff };
                } else {
                    if (outdoorDP >= inT) 
                        return { status: 'close', color: 'bg-red-600', icon: 'AlertTriangle', msg: 'åæ½®é è­¦ï¼æˆ¶å¤–éœ²é»éé«˜ã€‚', dpDiff, tDiff };
                    return { status: 'open', color: 'bg-blue-600', icon: 'Wind', msg: 'é€šé¢¨è‰¯å¥½ï¼Œæˆ¶å¤–è¼ƒä¹¾ç‡¥ã€‚', dpDiff, tDiff };
                }
            }, [inT, inH, outData, algoMode]);

            return (
                <div className="min-h-screen bg-slate-100 p-4 flex justify-center items-start font-sans">
                    <div className="max-w-md w-full bg-white shadow-2xl rounded-3xl overflow-hidden">
                        <header className="bg-slate-800 text-white p-5 flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <SafeIcon name="Wind" className="text-emerald-400" />
                                <h1 className="text-xl font-bold">é–‹çª—åŠ©æ‰‹</h1>
                            </div>
                        </header>

                        <div className="p-4 space-y-4">
                            <div className="flex bg-slate-100 p-1 rounded-xl shadow-inner text-sm font-bold">
                                <button onClick={()=>setAlgoMode('strict')} className={`flex-1 py-2 rounded-lg ${algoMode==='strict'?'bg-white shadow text-slate-800':'text-slate-400'}`}>åš´æ ¼é™¤æ¿•</button>
                                <button onClick={()=>setAlgoMode('standard')} className={`flex-1 py-2 rounded-lg ${algoMode==='standard'?'bg-white shadow text-slate-800':'text-slate-400'}`}>åŸºæœ¬é˜²æ½®</button>
                            </div>

                            <div className="bg-slate-50 p-4 rounded-2xl border">
                                <div className="flex justify-between items-center mb-3">
                                    <div className="flex items-center gap-1 text-sm font-bold text-slate-500"><SafeIcon name="Globe" size={14}/> æˆ¶å¤–</div>
                                    <button onClick={()=>setIsAuto(!isAuto)} className="text-[10px] px-2 py-1 bg-white border rounded shadow-sm">{isAuto?'è‡ªå‹•å®šä½ä¸­':'æ‰‹å‹•æ¨¡å¼'}</button>
                                </div>
                                {isAuto ? (
                                    <div className="flex gap-2 mb-3">
                                        <select value={city} onChange={e=>{setCity(e.target.value); setDist(Object.keys(TAIWAN_LOCATIONS[e.target.value])[0])}} className="flex-1 p-2 border rounded-lg text-sm">
                                            {Object.keys(TAIWAN_LOCATIONS).map(c=><option key={c}>{c}</option>)}
                                        </select>
                                        <select value={dist} onChange={e=>setDist(e.target.value)} className="flex-1 p-2 border rounded-lg text-sm">
                                            {Object.keys(TAIWAN_LOCATIONS[city]).map(d=><option key={d}>{d}</option>)}
                                        </select>
                                    </div>
                                ) : (
                                    <div className="flex gap-2 mb-3">
                                        <input type="number" value={outData.t} onChange={e=>setOutData({...outData, t: e.target.value})} className="flex-1 p-2 border rounded-lg text-sm" placeholder="æº«åº¦Â°C"/>
                                        <input type="number" value={outData.h} onChange={e=>setOutData({...outData, h: e.target.value})} className="flex-1 p-2 border rounded-lg text-sm" placeholder="æ¿•åº¦%"/>
                                    </div>
                                )}
                                <div className="grid grid-cols-2 gap-2">
                                    <div className="bg-white p-2 rounded-xl text-center shadow-sm border"><div className="text-[10px] text-slate-400">æº«åº¦</div><div className="font-bold">{outData.t}Â°</div></div>
                                    <div className="bg-white p-2 rounded-xl text-center shadow-sm border"><div className="text-[10px] text-slate-400">æ¿•åº¦</div><div className="font-bold">{outData.h}%</div></div>
                                </div>
                            </div>

                            <div className="bg-slate-50 p-4 rounded-2xl border">
                                <div className="flex items-center gap-1 text-sm font-bold text-slate-500 mb-3"><SafeIcon name="Thermometer" size={14}/> å®¤å…§</div>
                                <div className="grid grid-cols-2 gap-2">
                                    <input type="number" value={inT} onChange={e=>setInT(e.target.value)} className="p-2 border rounded-lg text-sm font-bold" />
                                    <input type="number" value={inH} onChange={e=>setInH(e.target.value)} className="p-2 border rounded-lg text-sm font-bold" />
                                </div>
                            </div>

                            <div className={`p-6 rounded-3xl text-white transition-all shadow-xl ${calc.color || 'bg-slate-400'}`}>
                                <div className="flex items-center gap-3 mb-2">
                                    <SafeIcon name={calc.icon || 'RefreshCw'} size={32} />
                                    <h2 className="text-3xl font-black">{calc.status === 'open' ? 'å»ºè­°é–‹çª—' : (calc.status === 'err' ? 'è¼‰å…¥ä¸­' : 'å»ºè­°é—œçª—')}</h2>
                                </div>
                                <p className="text-sm font-medium opacity-90">{calc.msg || 'æ­£åœ¨è¨ˆç®—ç’°å¢ƒæ•¸æ“š...'}</p>
                                {calc.dpDiff && (
                                    <div className="mt-4 pt-4 border-t border-white/20 flex justify-around">
                                        <div className="text-center"><div className="text-[10px] opacity-70">éœ²é»å·®</div><div className="text-xl font-mono font-bold">{calc.dpDiff}</div></div>
                                        <div className="text-center"><div className="text-[10px] opacity-70">æº«å·®</div><div className="text-xl font-mono font-bold">{calc.tDiff}</div></div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

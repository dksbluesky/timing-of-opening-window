<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é–‹çª—åŠ©æ‰‹ Pro - é›™åŠŸèƒ½ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/lucide-react@latest"></script>
</head>
<body class="bg-slate-100 min-h-screen flex items-center justify-center p-0 md:p-6">
    <div id="root" class="w-full max-w-lg"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // å®‰å…¨åœ–æ¨™çµ„ä»¶ï¼Œå¾¹åº•è§£æ±º Error #130
        const Icon = ({ name, size = 20, className = "" }) => {
            const lib = window.LucideReact || window.lucideReact;
            const Component = lib ? lib[name] : null;
            return Component ? <Component size={size} className={className} /> : <span>ğŸ“</span>;
        };

        const CWA_API_KEY = "CWA-BDD150F7-F455-44CA-8E6B-F548BBB011CB";
        const CWA_OBS_URL = "https://opendata.cwa.gov.tw/api/v1/rest/datastore/O-A0003-001?format=JSON";
        const CWA_FORECAST_URL = "https://opendata.cwa.gov.tw/api/v1/rest/datastore/F-D0047-091?format=JSON";

        // å…¨å°è¡Œæ”¿å€è³‡æ–™åº« (ç°¡ç´„ç‰ˆ)
        const TAIWAN_DATA = {
            "å°å—å¸‚": ["ä¸­è¥¿å€", "å®‰å¹³å€", "æ±å€", "å—å€", "åŒ—å€", "å®‰å—å€", "æ°¸åº·å€", "å–„åŒ–å€", "æ–°å¸‚å€", "ä»å¾·å€", "æ­¸ä»å€"],
            "å°åŒ—å¸‚": ["ä¸­æ­£å€", "å¤§å®‰å€", "ä¿¡ç¾©å€", "å£«æ—å€", "å…§æ¹–å€", "åŒ—æŠ•å€", "æ¾å±±å€"],
            "æ–°åŒ—å¸‚": ["æ¿æ©‹å€", "æ–°èŠå€", "ä¸­å’Œå€", "æ°¸å’Œå€", "æ·¡æ°´å€", "ä¸‰é‡å€", "æ—å£å€"],
            "å°ä¸­å¸‚": ["è¥¿å±¯å€", "åŒ—å±¯å€", "å—å±¯å€", "å¤ªå¹³å€", "å¤§é‡Œå€", "è±åŸå€"],
            "é«˜é›„å¸‚": ["å·¦ç‡Ÿå€", "å‰é®å€", "è‹“é›…å€", "ä¸‰æ°‘å€", "é³³å±±å€", "é¼“å±±å€"]
        };

        const calcDP = (T, RH) => {
            const t = parseFloat(T), h = parseFloat(RH);
            if (isNaN(t) || isNaN(h)) return null;
            const a = 17.27, b = 237.7;
            const alpha = ((a * t) / (b + t)) + Math.log(h / 100.0);
            return parseFloat(((b * alpha) / (a - alpha)).toFixed(1));
        };

        function App() {
            const [activeTab, setActiveTab] = useState('judge'); // judge æˆ– forecast
            const [city, setCity] = useState("å°å—å¸‚"); // é è¨­æ‰€åœ¨åœ°
            const [dist, setDist] = useState("ä¸­è¥¿å€");
            
            const [indoor, setIndoor] = useState({ t: 24.0, h: 60 });
            const [outdoor, setOutdoor] = useState({ t: null, h: null, station: "", loading: false });
            const [forecast, setForecast] = useState({ data: [], loading: false });

            // æŠ“å–ç•¶å‰è§€æ¸¬è³‡æ–™ (Tab 1)
            const fetchObs = async () => {
                setOutdoor(p => ({ ...p, loading: true }));
                try {
                    const res = await fetch(`${CWA_OBS_URL}&Authorization=${CWA_API_KEY}&locationName=${encodeURIComponent(city)}`);
                    const data = await res.json();
                    const stations = data.records.Station;
                    const match = stations.find(s => s.GeoInfo.TownName === dist) || stations[0];
                    setOutdoor({ t: match.WeatherElement.AirTemperature, h: match.WeatherElement.RelativeHumidity, station: match.StationName, loading: false });
                } catch (e) { setOutdoor(p => ({ ...p, loading: false })); }
            };

            // æŠ“å–ä¸€é€±é å ± (Tab 2)
            const fetchForecast = async () => {
                setForecast(p => ({ ...p, loading: true }));
                try {
                    const res = await fetch(`${CWA_FORECAST_URL}&Authorization=${CWA_API_KEY}&locationName=${encodeURIComponent(city)}`);
                    const json = await res.json();
                    const loc = json.records.Locations[0].Location.find(l => l.LocationName === dist) || json.records.Locations[0].Location[0];
                    
                    // å–å¾—é™é›¨æ©Ÿç‡ (PoP12h)
                    const popElement = loc.WeatherElement.find(e => e.ElementName === "PoP12h");
                    const rainData = popElement.Time.slice(0, 14).map(t => ({
                        time: t.StartTime.split(' ')[0].substring(5), // æ ¼å¼åŒ–æ—¥æœŸ MM-DD
                        period: t.StartTime.split(' ')[1].substring(0, 5), // æ™‚æ®µ
                        value: t.ElementValue[0].Value === " " ? 0 : parseInt(t.ElementValue[0].Value)
                    }));
                    setForecast({ data: rainData, loading: false });
                } catch (e) { setForecast(p => ({ ...p, loading: false })); }
            };

            useEffect(() => { fetchObs(); fetchForecast(); }, [city, dist]);

            const analysis = useMemo(() => {
                const inDP = calcDP(indoor.t, indoor.h);
                const outDP = calcDP(outdoor.t, outdoor.h);
                if (inDP === null || outDP === null) return null;
                const dpDiff = (inDP - outDP).toFixed(1);
                const tDiff = (outdoor.t - indoor.t).toFixed(1);
                
                const dOk = dpDiff >= 2.0, tOk = tDiff <= 3.0;
                return {
                    status: (dOk && tOk) ? 'open' : 'close',
                    color: (dOk && tOk) ? 'bg-emerald-600' : 'bg-slate-700',
                    items: [
                        { label: 'éœ²é»å·® (ç›®æ¨™â‰¥2.0)', val: dpDiff, pass: dOk },
                        { label: 'æº«å·® (ç›®æ¨™â‰¤3.0)', val: tDiff, pass: tOk }
                    ]
                };
            }, [indoor, outdoor]);

            return (
                <div className="bg-white min-h-screen md:min-h-0 md:rounded-[2.5rem] shadow-2xl flex flex-col overflow-hidden font-sans border border-slate-200">
                    <header className="bg-slate-900 text-white p-6 pb-4">
                        <div className="flex justify-between items-center mb-4">
                            <div className="flex items-center gap-3">
                                <Icon name="Wind" className="text-emerald-400" size={26} />
                                <h1 className="text-xl font-black tracking-tighter uppercase">CWA Pro åŠ©æ‰‹</h1>
                            </div>
                            <div className="text-[10px] text-emerald-400/70 border border-emerald-400/30 px-2 py-0.5 rounded-full font-mono">2026-02-01</div>
                        </div>

                        {/* å€åŸŸé¸æ“‡å™¨ (å…¨åŸŸåŒæ­¥) */}
                        <div className="grid grid-cols-2 gap-2">
                            <select value={city} onChange={e=>{setCity(e.target.value); setDist(TAIWAN_DATA[e.target.value][0])}} className="bg-white/10 border border-white/20 p-2 rounded-xl text-sm font-bold text-white outline-none">
                                {Object.keys(TAIWAN_DATA).map(c=><option key={c} value={c} className="text-slate-800">{c}</option>)}
                            </select>
                            <select value={dist} onChange={e=>setDist(e.target.value)} className="bg-white/10 border border-white/20 p-2 rounded-xl text-sm font-bold text-white outline-none">
                                {TAIWAN_DATA[city].map(d=><option key={d} value={d} className="text-slate-800">{d}</option>)}
                            </select>
                        </div>
                    </header>

                    {/* Tab æ§åˆ¶å™¨ */}
                    <nav className="flex bg-slate-900 px-6 pb-2">
                        <button onClick={()=>setActiveTab('judge')} className={`flex-1 py-2 text-xs font-black transition-all border-b-2 ${activeTab==='judge'?'border-emerald-400 text-emerald-400':'border-transparent text-slate-500'}`}>é–‹çª—åˆ¤æ–·</button>
                        <button onClick={()=>setActiveTab('forecast')} className={`flex-1 py-2 text-xs font-black transition-all border-b-2 ${activeTab==='forecast'?'border-emerald-400 text-emerald-400':'border-transparent text-slate-500'}`}>é™é›¨è¶¨å‹¢</button>
                    </nav>

                    <main className="p-5 flex-1 overflow-y-auto space-y-5 bg-white">
                        {activeTab === 'judge' ? (
                            <>
                                <section className="bg-slate-50 p-4 rounded-2xl border border-slate-200">
                                    <div className="flex justify-between items-center mb-4">
                                        <span className="text-[10px] font-bold text-slate-400 tracking-widest uppercase">å¯¦æ™‚æ¸¬ç«™è³‡æ–™</span>
                                        <span className="text-[9px] bg-emerald-100 text-emerald-600 px-2 py-0.5 rounded font-black">{outdoor.station} ç«™</span>
                                    </div>
                                    <div className="grid grid-cols-3 gap-2">
                                        <div className="bg-white p-3 rounded-2xl text-center border shadow-sm"><div className="text-[10px] text-slate-400 font-bold">æ¸¬ç«™æº«</div><div className="text-lg font-black">{outdoor.t??'--'}Â°</div></div>
                                        <div className="bg-white p-3 rounded-2xl text-center border shadow-sm"><div className="text-[10px] text-slate-400 font-bold">æ¿•åº¦</div><div className="text-lg font-black">{outdoor.h??'--'}%</div></div>
                                        <div className="bg-emerald-50 p-3 rounded-2xl text-center border border-emerald-100"><div className="text-[10px] text-emerald-600 font-bold">æ¸¬ç«™éœ²é»</div><div className="text-lg font-black text-emerald-600">{calcDP(outdoor.t, outdoor.h)??'--'}Â°</div></div>
                                    </div>
                                </section>

                                <section className="bg-slate-50 p-4 rounded-2xl border border-slate-200">
                                    <div className="text-[10px] font-bold text-slate-400 tracking-widest uppercase mb-4">å®¤å…§ç’°å¢ƒè¼¸å…¥</div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="text-[9px] text-slate-400 font-bold mb-1 block">å®¤æº« Â°C</label><input type="number" step="0.1" value={indoor.t} onChange={e=>setIndoor({...indoor, t: e.target.value})} className="w-full p-3 border rounded-xl font-black text-slate-700 shadow-sm" /></div>
                                        <div><label className="text-[9px] text-slate-400 font-bold mb-1 block">å®¤æ¿• %</label><input type="number" step="1" value={indoor.h} onChange={e=>setIndoor({...indoor, h: e.target.value})} className="w-full p-3 border rounded-xl font-black text-slate-700 shadow-sm" /></div>
                                    </div>
                                </section>

                                {analysis && (
                                    <section className={`${analysis.color} p-6 rounded-[2.5rem] text-white shadow-xl transition-all`}>
                                        <div className="flex items-center gap-4 mb-2">
                                            <Icon name={analysis.status==='open'?"CheckCircle":"XCircle"} size={32} />
                                            <h2 className="text-3xl font-black tracking-tighter">{analysis.status==='open'?'å»ºè­°é–‹çª—':'å»ºè­°é—œçª—'}</h2>
                                        </div>
                                        <div className="space-y-3 mt-6">
                                            {analysis.items.map((it, i)=>(
                                                <div key={i} className="bg-black/10 backdrop-blur-md rounded-2xl p-4 flex justify-between items-center border border-white/20">
                                                    <div><div className="text-[10px] font-bold opacity-60 uppercase">{it.label}</div><div className="text-2xl font-mono font-black">{it.val}</div></div>
                                                    <Icon name={it.pass?"CheckCircle":"XCircle"} className={it.pass?"text-emerald-300":"text-red-300"} size={24} />
                                                </div>
                                            ))}
                                        </div>
                                    </section>
                                )}
                            </>
                        ) : (
                            <section className="space-y-4">
                                <div className="bg-slate-900 p-6 rounded-[2.5rem] text-white shadow-xl">
                                    <h2 className="text-xl font-black mb-6 flex items-center gap-2"><Icon name="CloudRain" className="text-blue-400" /> ä¸€é€±é™é›¨è¶¨å‹¢</h2>
                                    <div className="flex items-end justify-between h-48 gap-1 px-2">
                                        {forecast.data.map((d, i)=>(
                                            <div key={i} className="flex-1 flex flex-col items-center group">
                                                <div className="text-[8px] mb-1 opacity-0 group-hover:opacity-100 transition-all font-bold">{d.value}%</div>
                                                <div className="w-full bg-blue-500/30 rounded-t-sm relative transition-all hover:bg-blue-400" style={{ height: `${Math.max(d.value, 5)}%` }}>
                                                    {d.value >= 50 && <div className="absolute top-1 left-1/2 -translate-x-1/2 text-[8px]">â˜”</div>}
                                                </div>
                                                <div className="text-[7px] mt-2 rotate-45 origin-left whitespace-nowrap opacity-60 font-bold">{d.time}</div>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="mt-12 text-[10px] text-slate-400 flex justify-between border-t border-white/10 pt-4">
                                        <span>* é¡¯ç¤ºæœªä¾† 72 å°æ™‚æ¯ 12 å°æ™‚æ©Ÿç‡</span>
                                        <span className="text-blue-400 font-bold">é«˜æ–¼ 50% å»ºè­°é—œçª—</span>
                                    </div>
                                </div>
                                <div className="p-4 bg-slate-50 rounded-2xl border border-slate-200 text-xs text-slate-500 leading-relaxed">
                                    ğŸ’¡ å°ˆæ¥­æç¤ºï¼šå³ä½¿é–‹çª—æ¢ä»¶ç¬¦åˆï¼Œè‹¥é™é›¨æ©Ÿç‡é«˜æ–¼ 30%ï¼Œå»ºè­°ç•™åœ¨å®¤å…§è§€å¯Ÿé›²å±¤è®ŠåŒ–ã€‚
                                </div>
                            </section>
                        )}
                    </main>
                    <footer className="p-4 text-center text-[9px] text-slate-400 border-t bg-slate-50 font-bold tracking-widest">
                        DATA SOURCE: CENTRAL WEATHER ADMINISTRATION (CWA)
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

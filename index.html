<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>開窗判斷助手</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        // 關鍵點：必須加上 ?external=react 避免重複載入 React 導致 Hook 失效
        import { Wind, Thermometer, MapPin, AlertTriangle, CheckCircle, XCircle, RefreshCw, Settings, Globe } from 'https://esm.sh/lucide-react@0.263.1?external=react';

        const TAIWAN_LOCATIONS = {
            "基隆市": { "仁愛區": { lat: 25.128, lon: 121.742 }, "信義區": { lat: 25.128, lon: 121.758 }, "中正區": { lat: 25.141, lon: 121.756 }, "中山區": { lat: 25.148, lon: 121.733 }, "安樂區": { lat: 25.133, lon: 121.716 }, "七堵區": { lat: 25.094, lon: 121.712 } },
            "台北市": { "中正區": { lat: 25.032, lon: 121.519 }, "大安區": { lat: 25.026, lon: 121.543 }, "信義區": { lat: 25.033, lon: 121.565 }, "士林區": { lat: 25.092, lon: 121.525 }, "北投區": { lat: 25.132, lon: 121.498 }, "內湖區": { lat: 25.074, lon: 121.581 }, "南港區": { lat: 25.055, lon: 121.610 }, "松山區": { lat: 25.058, lon: 121.558 }, "萬華區": { lat: 25.035, lon: 121.499 }, "文山區": { lat: 24.998, lon: 121.559 }, "大同區": { lat: 25.063, lon: 121.513 }, "中山區": { lat: 25.064, lon: 121.533 } },
            "新北市": { "板橋區": { lat: 25.014, lon: 121.463 }, "新莊區": { lat: 25.036, lon: 121.450 }, "中和區": { lat: 24.993, lon: 121.503 }, "永和區": { lat: 25.008, lon: 121.513 }, "淡水區": { lat: 25.176, lon: 121.446 }, "林口區": { lat: 25.077, lon: 121.393 }, "三重區": { lat: 25.063, lon: 121.492 }, "蘆洲區": { lat: 25.083, lon: 121.472 }, "新店區": { lat: 24.967, lon: 121.542 }, "汐止區": { lat: 25.067, lon: 121.659 }, "土城區": { lat: 24.973, lon: 121.444 }, "樹林區": { lat: 24.991, lon: 121.416 }, "三峽區": { lat: 24.934, lon: 121.368 }, "鶯歌區": { lat: 24.954, lon: 121.348 }, "五股區": { lat: 25.084, lon: 121.439 }, "泰山區": { lat: 25.057, lon: 121.432 } },
            "桃園市": { "桃園區": { lat: 24.993, lon: 121.301 }, "中壢區": { lat: 24.965, lon: 121.225 }, "龜山區": { lat: 25.000, lon: 121.346 }, "八德區": { lat: 24.947, lon: 121.296 }, "楊梅區": { lat: 24.908, lon: 121.145 }, "蘆竹區": { lat: 25.048, lon: 121.291 }, "大溪區": { lat: 24.881, lon: 121.286 }, "龍潭區": { lat: 24.863, lon: 121.216 }, "平鎮區": { lat: 24.942, lon: 121.215 }, "大園區": { lat: 25.064, lon: 121.196 }, "觀音區": { lat: 25.036, lon: 121.082 }, "新屋區": { lat: 24.972, lon: 121.018 } },
            "新竹市": { "東區": { lat: 24.795, lon: 120.992 }, "北區": { lat: 24.819, lon: 120.957 }, "香山區": { lat: 24.770, lon: 120.941 } },
            "新竹縣": { "竹北市": { lat: 24.839, lon: 121.009 }, "竹東鎮": { lat: 24.739, lon: 121.094 }, "新豐鄉": { lat: 24.899, lon: 120.993 }, "湖口鄉": { lat: 24.904, lon: 121.044 }, "新埔鎮": { lat: 24.827, lon: 121.074 }, "關西鎮": { lat: 24.794, lon: 121.171 }, "芎林鄉": { lat: 24.774, lon: 121.082 }, "寶山鄉": { lat: 24.761, lon: 121.037 } },
            "苗栗縣": { "苗栗市": { lat: 24.564, lon: 120.820 }, "頭份市": { lat: 24.687, lon: 120.910 }, "竹南鎮": { lat: 24.686, lon: 120.879 }, "苑裡鎮": { lat: 24.442, lon: 120.648 }, "後龍鎮": { lat: 24.613, lon: 120.787 }, "通霄鎮": { lat: 24.490, lon: 120.678 }, "公館鄉": { lat: 24.502, lon: 120.825 }, "銅鑼鄉": { lat: 24.485, lon: 120.788 } },
            "台中市": { "中區": { lat: 24.145, lon: 120.678 }, "西屯區": { lat: 24.163, lon: 120.640 }, "北屯區": { lat: 24.180, lon: 120.718 }, "南屯區": { lat: 24.137, lon: 120.643 }, "西區": { lat: 24.140, lon: 120.663 }, "南區": { lat: 24.122, lon: 120.666 }, "北區": { lat: 24.166, lon: 120.679 }, "豐原區": { lat: 24.256, lon: 120.723 }, "大里區": { lat: 24.099, lon: 120.694 }, "太平區": { lat: 24.126, lon: 120.718 }, "東勢區": { lat: 24.258, lon: 120.829 }, "大甲區": { lat: 24.346, lon: 120.622 }, "清水區": { lat: 24.269, lon: 120.574 }, "沙鹿區": { lat: 24.234, lon: 120.560 }, "梧棲區": { lat: 24.254, lon: 120.536 }, "烏日區": { lat: 24.105, lon: 120.623 } },
            "彰化縣": { "彰化市": { lat: 24.081, lon: 120.538 }, "員林市": { lat: 23.959, lon: 120.570 }, "鹿港鎮": { lat: 24.058, lon: 120.435 }, "和美鎮": { lat: 24.110, lon: 120.500 }, "北斗鎮": { lat: 23.872, lon: 120.525 }, "溪湖鎮": { lat: 23.960, lon: 120.479 }, "田中鎮": { lat: 23.859, lon: 120.589 }, "二林鎮": { lat: 23.899, lon: 120.373 } },
            "南投縣": { "南投市": { lat: 23.910, lon: 120.686 }, "埔里鎮": { lat: 23.965, lon: 120.969 }, "草屯鎮": { lat: 23.978, lon: 120.684 }, "竹山鎮": { lat: 23.755, lon: 120.681 }, "集集鎮": { lat: 23.829, lon: 120.785 }, "名間鄉": { lat: 23.839, lon: 120.686 }, "鹿谷鄉": { lat: 23.744, lon: 120.751 }, "魚池鄉": { lat: 23.897, lon: 120.936 } },
            "雲林縣": { "斗六市": { lat: 23.709, lon: 120.543 }, "虎尾鎮": { lat: 23.708, lon: 120.435 }, "斗南鎮": { lat: 23.676, lon: 120.479 }, "西螺鎮": { lat: 23.795, lon: 120.460 }, "土庫鎮": { lat: 23.676, lon: 120.393 }, "北港鎮": { lat: 23.575, lon: 120.306 }, "麥寮鄉": { lat: 23.755, lon: 120.252 }, "古坑鄉": { lat: 23.645, lon: 120.560 } },
            "嘉義市": { "東區": { lat: 23.486, lon: 120.461 }, "西區": { lat: 23.479, lon: 120.432 } },
            "嘉義縣": { "太保市": { lat: 23.459, lon: 120.332 }, "朴子市": { lat: 23.465, lon: 120.247 }, "布袋鎮": { lat: 23.378, lon: 120.165 }, "大林鎮": { lat: 23.601, lon: 120.473 }, "民雄鄉": { lat: 23.551, lon: 120.431 }, "水上鄉": { lat: 23.429, lon: 120.413 }, "中埔鄉": { lat: 23.426, lon: 120.520 }, "竹崎鄉": { lat: 23.522, lon: 120.552 } },
            "台南市": { "中西區": { lat: 22.992, lon: 120.197 }, "安平區": { lat: 22.998, lon: 120.165 }, "永康區": { lat: 23.017, lon: 120.262 }, "東區": { lat: 22.986, lon: 120.218 }, "北區": { lat: 23.007, lon: 120.207 }, "南區": { lat: 22.959, lon: 120.184 }, "安南區": { lat: 23.047, lon: 120.183 }, "歸仁區": { lat: 22.969, lon: 120.295 }, "仁德區": { lat: 22.971, lon: 120.252 }, "新化區": { lat: 23.038, lon: 120.309 }, "善化區": { lat: 23.131, lon: 120.295 }, "新市區": { lat: 23.076, lon: 120.294 } },
            "高雄市": { "苓雅區": { lat: 22.623, lon: 120.312 }, "左營區": { lat: 22.693, lon: 120.297 }, "鳳山區": { lat: 22.626, lon: 120.357 }, "鼓山區": { lat: 22.651, lon: 120.274 }, "三民區": { lat: 22.646, lon: 120.309 }, "前鎮區": { lat: 22.592, lon: 120.316 }, "旗津區": { lat: 22.569, lon: 120.278 }, "小港區": { lat: 22.565, lon: 120.355 }, "楠梓區": { lat: 22.729, lon: 120.326 }, "岡山區": { lat: 22.796, lon: 120.296 }, "仁武區": { lat: 22.699, lon: 120.347 }, "大寮區": { lat: 22.605, lon: 120.395 } },
            "屏東縣": { "屏東市": { lat: 22.669, lon: 120.486 }, "潮州鎮": { lat: 22.550, lon: 120.542 }, "東港鎮": { lat: 22.467, lon: 120.453 }, "恆春鎮": { lat: 22.003, lon: 120.743 }, "萬丹鄉": { lat: 22.590, lon: 120.485 }, "長治鄉": { lat: 22.679, lon: 120.528 }, "九如鄉": { lat: 22.739, lon: 120.488 }, "里港鄉": { lat: 22.778, lon: 120.495 } },
            "宜蘭縣": { "宜蘭市": { lat: 24.757, lon: 121.752 }, "羅東鎮": { lat: 24.675, lon: 121.767 }, "蘇澳鎮": { lat: 24.594, lon: 121.841 }, "頭城鎮": { lat: 24.858, lon: 121.823 }, "礁溪鄉": { lat: 24.825, lon: 121.770 }, "壯圍鄉": { lat: 24.745, lon: 121.782 }, "五結鄉": { lat: 24.693, lon: 121.795 }, "冬山鄉": { lat: 24.634, lon: 121.792 } },
            "花蓮縣": { "花蓮市": { lat: 23.976, lon: 121.606 }, "鳳林鎮": { lat: 23.745, lon: 121.450 }, "玉里鎮": { lat: 23.336, lon: 121.310 }, "吉安鄉": { lat: 23.960, lon: 121.568 }, "新城鄉": { lat: 24.025, lon: 121.623 }, "壽豐鄉": { lat: 23.871, lon: 121.507 }, "光復鄉": { lat: 23.666, lon: 121.423 }, "瑞穗鄉": { lat: 23.498, lon: 121.378 } },
            "台東縣": { "台東市": { lat: 22.756, lon: 121.144 }, "成功鎮": { lat: 23.100, lon: 121.378 }, "關山鎮": { lat: 23.048, lon: 121.163 }, "卑南鄉": { lat: 22.787, lon: 121.092 }, "鹿野鄉": { lat: 22.912, lon: 121.157 }, "池上鄉": { lat: 23.122, lon: 121.216 }, "東河鄉": { lat: 22.969, lon: 121.302 }, "太麻里": { lat: 22.615, lon: 121.006 } },
            "澎湖縣": { "馬公市": { lat: 23.565, lon: 119.563 } },
            "金門縣": { "金城鎮": { lat: 24.417, lon: 118.317 } },
        };

        const calculateDewPoint = (T, RH) => {
            if (T === "" || RH === "" || isNaN(T) || isNaN(RH)) return null;
            const a = 17.27;
            const b = 237.7;
            const alpha = ((a * T) / (b + T)) + Math.log(RH / 100.0);
            return parseFloat(((b * alpha) / (a - alpha)).toFixed(1));
        };

        function App() {
            const [algoMode, setAlgoMode] = useState('strict'); 
            const [isAutoOutdoor, setIsAutoOutdoor] = useState(true);
            const [triggerFetch, setTriggerFetch] = useState(0); 
            
            const [selectedCity, setSelectedCity] = useState("台北市");
            const [selectedDistrict, setSelectedDistrict] = useState("中正區");
            
            const [indoorTemp, setIndoorTemp] = useState(24.0);
            const [indoorHumid, setIndoorHumid] = useState(60);

            const [outdoorData, setOutdoorData] = useState({ temp: null, humid: null, loading: false, error: null });
            const [manualOutTemp, setManualOutTemp] = useState(25.0); 
            const [manualOutHumid, setManualOutHumid] = useState(55);

            useEffect(() => {
                if (!isAutoOutdoor) return;
                const fetchData = async () => {
                    setOutdoorData(prev => ({ ...prev, loading: true, error: null }));
                    const location = TAIWAN_LOCATIONS[selectedCity]?.[selectedDistrict];
                    if (!location) {
                        setOutdoorData({ temp: null, humid: null, loading: false, error: "地點錯誤" });
                        return;
                    }
                    try {
                        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${location.lat}&longitude=${location.lon}&current=temperature_2m,relative_humidity_2m&timezone=auto`);
                        if (!res.ok) throw new Error("API連線失敗");
                        const data = await res.json();
                        setOutdoorData({ temp: data.current.temperature_2m, humid: data.current.relative_humidity_2m, loading: false, error: null });
                    } catch (err) {
                        setOutdoorData(prev => ({ ...prev, loading: false, error: "網路連線失敗" }));
                    }
                };
                fetchData();
            }, [selectedCity, selectedDistrict, isAutoOutdoor, triggerFetch]);

            const calculation = useMemo(() => {
                const inT = parseFloat(indoorTemp);
                const inH = parseFloat(indoorHumid);
                const inDP = calculateDewPoint(inT, inH);
                const outT = isAutoOutdoor ? outdoorData.temp : parseFloat(manualOutTemp);
                const outH = isAutoOutdoor ? outdoorData.humid : parseFloat(manualOutHumid);
                const outDP = calculateDewPoint(outT, outH);

                if (inDP === null || outDP === null) {
                    return { status: "loading", reason: outdoorData.loading ? "連線中..." : "請檢查數據內容", color: "bg-slate-400" };
                }

                const dpDiff = (inDP - outDP).toFixed(1);
                const tDiff = (outT - inT).toFixed(1);
                let res = { inDP, outDP, outT, outH, dpDiff, tDiff };

                if (algoMode === 'strict') {
                    if (dpDiff >= 2.0 && tDiff <= 3.0) {
                        return { ...res, status: "open", reason: "【建議開窗】戶外乾燥且溫度適宜，符合除濕標準！", color: "bg-emerald-600", icon: "open" };
                    }
                    return { ...res, status: "close", reason: "建議關窗 (未達嚴格除濕標準)。", color: "bg-slate-600", icon: "close" };
                } else {
                    if (outDP >= inT) return { ...res, status: "close", reason: "⚠️ 反潮危險！戶外露點 > 室內氣溫，開窗會結露。", color: "bg-red-600", icon: "danger" };
                    if (outDP < inDP) return { ...res, status: "open", reason: "戶外空氣較乾燥，適合一般通風。", color: "bg-blue-600", icon: "open" };
                    return { ...res, status: "close", reason: "戶外濕氣較重，不建議開窗。", color: "bg-orange-500", icon: "close" };
                }
            }, [indoorTemp, indoorHumid, outdoorData, manualOutTemp, manualOutHumid, isAutoOutdoor, algoMode]);

            return (
                <div className="min-h-screen bg-slate-100 p-4 flex flex-col items-center">
                    <div className="max-w-md w-full bg-white shadow-xl rounded-3xl overflow-hidden border border-slate-200">
                        <header className="bg-emerald-700 text-white p-4 flex justify-between items-center">
                            <div className="flex items-center gap-2"><Wind size={20}/><h1 className="font-bold">開窗判斷助手</h1></div>
                            <span className="text-[10px] bg-white/20 px-2 py-1 rounded">TW Weather</span>
                        </header>

                        <div className="p-4 space-y-4">
                            {/* 判斷邏輯切換 */}
                            <div className="flex gap-2 p-1 bg-slate-100 rounded-xl">
                                <button onClick={()=>setAlgoMode('strict')} className={`flex-1 p-2 rounded-lg text-xs font-bold transition-all ${algoMode==='strict'?'bg-white shadow text-emerald-700':'text-slate-500'}`}>嚴格強效除濕</button>
                                <button onClick={()=>setAlgoMode('standard')} className={`flex-1 p-2 rounded-lg text-xs font-bold transition-all ${algoMode==='standard'?'bg-white shadow text-blue-700':'text-slate-500'}`}>一般物理防潮</button>
                            </div>

                            {/* 戶外數據 */}
                            <section className="bg-slate-50 rounded-2xl p-4 border border-slate-100">
                                <div className="flex justify-between items-center mb-3">
                                    <div className="flex items-center gap-2 text-sm font-bold text-slate-600"><Globe size={16}/> 戶外環境</div>
                                    <div className="flex bg-white rounded-lg p-0.5 shadow-sm border">
                                        <button onClick={()=>setIsAutoOutdoor(true)} className={`px-3 py-1 text-[10px] rounded-md ${isAutoOutdoor?'bg-emerald-100 text-emerald-700 font-bold':'text-slate-400'}`}>自動</button>
                                        <button onClick={()=>setIsAutoOutdoor(false)} className={`px-3 py-1 text-[10px] rounded-md ${!isAutoOutdoor?'bg-emerald-100 text-emerald-700 font-bold':'text-slate-400'}`}>手動</button>
                                    </div>
                                </div>

                                {isAutoOutdoor ? (
                                    <div className="grid grid-cols-2 gap-2 mb-3">
                                        <select value={selectedCity} onChange={e=>{setSelectedCity(e.target.value); setSelectedDistrict(Object.keys(TAIWAN_LOCATIONS[e.target.value])[0])}} className="text-xs p-2 border rounded-lg outline-none">
                                            {Object.keys(TAIWAN_LOCATIONS).map(c=><option key={c} value={c}>{c}</option>)}
                                        </select>
                                        <select value={selectedDistrict} onChange={e=>setSelectedDistrict(e.target.value)} className="text-xs p-2 border rounded-lg outline-none">
                                            {Object.keys(TAIWAN_LOCATIONS[selectedCity]).map(d=><option key={d} value={d}>{d}</option>)}
                                        </select>
                                    </div>
                                ) : (
                                    <div className="grid grid-cols-2 gap-2 mb-3">
                                        <input type="number" value={manualOutTemp} onChange={e=>setManualOutTemp(e.target.value)} className="text-xs p-2 border rounded-lg" placeholder="溫°C"/>
                                        <input type="number" value={manualOutHumid} onChange={e=>setManualOutHumid(e.target.value)} className="text-xs p-2 border rounded-lg" placeholder="濕%"/>
                                    </div>
                                )}

                                <div className="grid grid-cols-3 gap-2 text-center">
                                    <div className="bg-white p-2 rounded-xl shadow-sm"><div className="text-[10px] text-slate-400">溫度</div><div className="font-bold text-slate-700">{calculation.outT ?? '--'}°</div></div>
                                    <div className="bg-white p-2 rounded-xl shadow-sm"><div className="text-[10px] text-slate-400">濕度</div><div className="font-bold text-slate-700">{calculation.outH ?? '--'}%</div></div>
                                    <div className="bg-emerald-50 p-2 rounded-xl shadow-sm border border-emerald-100"><div className="text-[10px] text-emerald-600 font-bold">露點</div><div className="font-bold text-emerald-600">{calculation.outDP ?? '--'}°</div></div>
                                </div>
                            </section>

                            {/* 室內數據 */}
                            <section className="bg-slate-50 rounded-2xl p-4 border border-slate-100">
                                <div className="flex items-center gap-2 text-sm font-bold text-slate-600 mb-3"><Thermometer size={16}/> 室內環境</div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div><label className="text-[10px] text-slate-400 font-bold ml-1">溫度 °C</label><input type="number" value={indoorTemp} onChange={e=>setIndoorTemp(e.target.value)} className="w-full text-sm p-2 border rounded-lg font-bold text-slate-700"/></div>
                                    <div><label className="text-[10px] text-slate-400 font-bold ml-1">濕度 %</label><input type="number" value={indoorHumid} onChange={e=>setIndoorHumid(e.target.value)} className="w-full text-sm p-2 border rounded-lg font-bold text-slate-700"/></div>
                                </div>
                            </section>

                            {/* 判斷結果 */}
                            <section className={`rounded-2xl p-6 text-white transition-all shadow-lg ${calculation.color}`}>
                                <div className="flex items-center gap-3 mb-2">
                                    {calculation.icon === 'open' ? <CheckCircle size={28}/> : (calculation.icon === 'danger' ? <AlertTriangle size={28}/> : <XCircle size={28}/>)}
                                    <h2 className="text-2xl font-bold">{calculation.status === "open" ? "建議開窗" : (calculation.status === "loading" ? "請稍候" : "建議關窗")}</h2>
                                </div>
                                <p className="text-sm opacity-90 font-medium mb-4">{calculation.reason}</p>
                                
                                {calculation.status !== 'loading' && algoMode === 'strict' && (
                                    <div className="grid grid-cols-2 gap-2 border-t border-white/20 pt-4">
                                        <div className="bg-white/10 p-2 rounded-lg text-center">
                                            <div className="text-[10px] opacity-70">露點差 (目標≥2)</div>
                                            <div className="text-xl font-mono font-bold">{calculation.dpDiff}</div>
                                        </div>
                                        <div className="bg-white/10 p-2 rounded-lg text-center">
                                            <div className="text-[10px] opacity-70">溫差 (目標≤3)</div>
                                            <div className="text-xl font-mono font-bold">{calculation.tDiff}</div>
                                        </div>
                                    </div>
                                )}
                            </section>
                        </div>
                    </div>
                </div>
            );
        }

        const container = document.getElementById('root');
        const root = createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>

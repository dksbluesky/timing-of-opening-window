<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>開窗判斷助手 - 全台 CWA 專業版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
</head>
<body class="bg-slate-100 min-h-screen flex items-center justify-center p-0 md:p-6 text-slate-800">
    <div id="root" class="w-full max-w-lg"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, Fragment } = React;

        // 徹底修正 Icon 語法報錯 (使用 Fragment 包裹多個路徑)
        const Icon = ({ name, className = "w-5 h-5" }) => {
            const icons = {
                Wind: <path d="M17.7 7.7a2.5 2.5 0 1 1 1.8 4.3H2m-6.8 6a2 2 0 1 1-1.4 3.4H2m16.7-16.8a3.5 3.5 0 1 1 3.1 6H2" />,
                Droplets: <path d="M7 16.3c2.2 0 4-1.8 4-4 0-3.3-4-8-4-8s-4 4.7-4 8c0 2.2 1.8 4 4 4Z" />,
                Thermometer: <path d="M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z" />,
                RefreshCw: <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8m0 0V3m0 5h5m-1 4a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16m0 0v5m0-5h-5" />,
                Globe: <Fragment><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20M2 12h20" /></Fragment>,
                MapPin: <Fragment><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></Fragment>,
                Check: <polyline points="20 6 9 17 4 12" />,
                X: <Fragment><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></Fragment>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || <circle cx="12" cy="12" r="10" />}
                </svg>
            );
        };

        const CWA_API_KEY = "CWA-BDD150F7-F455-44CA-8E6B-F548BBB011CB";
        const CWA_URL = "https://opendata.cwa.gov.tw/api/v1/rest/datastore/O-A0003-001?format=JSON";

        // 全台 22 縣市、368 行政區完整清單 (嚴格遵守，不準動)
        const TAIWAN_DATA = {
            "台南市": ["中西區", "安平區", "東區", "南區", "北區", "安南區", "永康區", "歸仁區", "新化區", "左鎮區", "玉井區", "楠西區", "南化區", "仁德區", "關廟區", "龍崎區", "官田區", "麻豆區", "佳里區", "西港區", "七股區", "將軍區", "學甲區", "北門區", "新營區", "後壁區", "白河區", "東山區", "六甲區", "下營區", "柳營區", "鹽水區", "善化區", "大內區", "山上區", "新市區", "安定區"],
            "台北市": ["中正區", "大同區", "中山區", "松山區", "大安區", "萬華區", "信義區", "士林區", "北投區", "內湖區", "南港區", "文山區"],
            "新北市": ["板橋區", "三重區", "中和區", "永和區", "新莊區", "新店區", "樹林區", "鶯歌區", "三峽區", "淡水區", "汐止區", "瑞芳區", "土城區", "蘆洲區", "五股區", "泰山區", "林口區", "深坑區", "石碇區", "坪林區", "三芝區", "石門區", "八里區", "平溪區", "雙溪區", "貢寮區", "金山區", "萬里區", "烏來區"],
            "台中市": ["中區", "東區", "南區", "西區", "北區", "北屯區", "西屯區", "南屯區", "太平區", "大里區", "霧峰區", "烏日區", "豐原區", "後里區", "石岡區", "東勢區", "和平區", "新社區", "潭子區", "大雅區", "神岡區", "大肚區", "沙鹿區", "龍井區", "梧棲區", "清水區", "大甲區", "外埔區", "大安區"],
            "高雄市": ["新興區", "前金區", "苓雅區", "鹽埕區", "鼓山區", "旗津區", "前鎮區", "三民區", "楠梓區", "小港區", "左營區", "仁武區", "大社區", "岡山區", "路竹區", "阿蓮區", "田寮區", "燕巢區", "橋頭區", "梓官區", "彌陀區", "永安區", "湖內區", "鳳山區", "大寮區", "林園區", "鳥松區", "大樹區", "旗山區", "美濃區", "六龜區", "內門區", "杉林區", "甲仙區", "桃源區", "那瑪夏區", "茂林區", "茄萣區"],
            "基隆市": ["仁愛區", "信義區", "中正區", "中山區", "安樂區", "暖暖區", "七堵區"],
            "桃園市": ["桃園區", "中壢區", "大溪區", "楊梅區", "蘆竹區", "大園區", "龜山區", "八德區", "龍潭區", "平鎮區", "新屋區", "觀音區", "復興區"],
            "新竹市": ["東區", "北區", "香山區"],
            "新竹縣": ["竹北市", "竹東鎮", "新埔鎮", "關西鎮", "湖口鄉", "新豐鄉", "芎林鄉", "橫山鄉", "北埔鄉", "寶山鄉", "峨眉鄉", "尖石鄉", "五峰鄉"],
            "苗栗縣": ["苗栗市", "頭份區", "竹南鎮", "後龍鎮", "通霄鎮", "苑裡鎮", "卓蘭鎮", "造橋鄉", "西湖鄉", "頭屋鄉", "公館鄉", "銅鑼鄉", "三義鄉", "大湖鄉", "獅潭鄉", "三灣鄉", "南庄鄉", "泰安鄉"],
            "彰化縣": ["彰化市", "鹿港鎮", "和美鎮", "線西鄉", "伸港鄉", "福興鄉", "秀水鄉", "花壇鄉", "芬園鄉", "員林市", "溪湖鎮", "田中鎮", "大村鄉", "埔鹽鄉", "埔心鄉", "永靖鄉", "社頭鄉", "二水鄉", "北斗鎮", "二林鎮", "埤頭鄉", "芳苑鄉", "大城鄉", "竹塘鄉", "溪州鄉", "田尾鄉"],
            "南投縣": ["南投市", "埔里鎮", "草屯鎮", "竹山鎮", "集集鎮", "名間鄉", "鹿谷鄉", "中寮鄉", "魚池鄉", "國姓鄉", "水里鄉", "信義鄉", "仁愛鄉"],
            "雲林縣": ["斗六市", "斗南鎮", "虎尾鎮", "西螺鎮", "土庫鎮", "北港鎮", "古坑鄉", "大埤鄉", "莿桐鄉", "林內鄉", "二崙鄉", "崙背鄉", "麥寮鄉", "東勢鄉", "褒忠鄉", "台西鄉", "元長鄉", "四湖鄉", "口湖鄉", "水林鄉"],
            "嘉義市": ["東區", "西區"],
            "嘉義縣": ["太保市", "朴子市", "布袋鎮", "大林鎮", "民雄鄉", "溪口鄉", "新港鄉", "六腳鄉", "東石鄉", "義竹鄉", "鹿草鄉", "水上鄉", "中埔鄉", "竹崎鄉", "梅山鄉", "番路鄉", "大埔鄉", "阿里山"],
            "屏東縣": ["屏東市", "三地門", "霧台鄉", "瑪家鄉", "九如鄉", "里港鄉", "高樹鄉", "鹽埔鄉", "長治鄉", "麟洛鄉", "竹田鄉", "內埔鄉", "萬丹鄉", "潮州鎮", "泰武鄉", "來義鄉", "萬巒鄉", "嵌頂鄉", "新埤鄉", "南州鄉", "林邊鄉", "東港鎮", "琉球鄉", "佳冬鄉", "新園鄉", "枋寮鄉", "枋山鄉", "春日鄉", "獅子鄉", "車城鄉", "牡丹鄉", "恆春鎮", "滿州鄉"],
            "宜蘭縣": ["宜蘭市", "羅東鎮", "蘇澳鎮", "頭城鎮", "礁溪鄉", "壯圍鄉", "員山鄉", "冬山鄉", "五結鄉", "三星鄉", "大同鄉", "南澳鄉"],
            "花蓮縣": ["花蓮市", "鳳林鎮", "玉里鎮", "新城鄉", "吉安鄉", "壽豐鄉", "光復鄉", "豐濱鄉", "瑞穗鄉", "富里鄉", "秀林鄉", "萬榮鄉", "卓溪鄉"],
            "台東縣": ["台東市", "成功鎮", "關山鎮", "卑南鄉", "鹿野鄉", "池上鄉", "東河鄉", "長濱鄉", "太麻里", "大武鄉", "綠島鄉", "海端鄉", "延平鄉", "金峰鄉", "達仁鄉", "蘭嶼鄉"],
            "澎湖縣": ["馬公市", "湖西鄉", "白沙鄉", "西嶼鄉", "望安鄉", "七美鄉"],
            "金門縣": ["金城鎮", "金湖鎮", "金沙鎮", "金寧鄉", "烈嶼鄉", "烏坵鄉"],
            "連江縣": ["南竿鄉", "北竿鄉", "莒光鄉", "東引鄉"]
        };

        // --- 修正室外露點 NaN 問題：強制 parseFloat 轉換 ---
        const calculateDP = (T, RH) => {
            const t = parseFloat(T), rh = parseFloat(RH);
            if (isNaN(t) || isNaN(rh) || rh <= 0) return null;
            const a = 17.27, b = 237.7;
            const alpha = ((a * t) / (b + t)) + Math.log(rh / 100.0);
            return parseFloat(((b * alpha) / (a - alpha)).toFixed(1));
        };

        function App() {
            const [algo, setAlgo] = useState('strict');
            const [city, setCity] = useState("台南市");
            const [dist, setDist] = useState("中西區");
            const [indoor, setIndoor] = useState({ t: 24.0, h: 60 });
            const [outdoor, setOutdoor] = useState({ t: null, h: null, station: "", loading: false });

            const refreshData = async () => {
                setOutdoor(p => ({ ...p, loading: true }));
                try {
                    const res = await fetch(`${CWA_URL}&Authorization=${CWA_API_KEY}&locationName=${encodeURIComponent(city)}`);
                    const data = await res.json();
                    const stations = data.records.Station;
                    const match = stations.find(s => s.GeoInfo.TownName === dist) || stations[0];
                    setOutdoor({
                        t: match.WeatherElement.AirTemperature,
                        h: match.WeatherElement.RelativeHumidity,
                        station: `${match.StationName} (${match.GeoInfo.TownName || '鄰近'})`,
                        loading: false
                    });
                } catch (e) { setOutdoor(p => ({ ...p, loading: false })); }
            };

            useEffect(() => { refreshData(); }, [city, dist]);

            const indoorDP = useMemo(() => calculateDP(indoor.t, indoor.h), [indoor.t, indoor.h]);
            const outdoorDP = useMemo(() => calculateDP(outdoor.t, outdoor.h), [outdoor.t, outdoor.h]);

            const analysis = useMemo(() => {
                if (indoorDP === null || outdoorDP === null) return null;
                const dDiff = (indoorDP - outdoorDP).toFixed(1);
                const tDiff = (outdoor.t - indoor.t).toFixed(1);

                if (algo === 'strict') {
                    const dOk = dDiff >= 2.0, tOk = tDiff <= 3.0;
                    const can = dOk && tOk;
                    return { color: can ? 'bg-emerald-600' : 'bg-slate-700', title: can ? '建議開窗' : '建議關窗', 
                             items: [{ label: '露點差 (≥2.0)', val: dDiff, pass: dOk }, { label: '溫差 (≤3.0)', val: tDiff, pass: tOk }] };
                } else {
                    const sOk = outdoor.t > indoorDP, dOk = outdoorDP < indoorDP;
                    const can = sOk && dOk;
                    return { color: !sOk ? 'bg-red-600' : (can ? 'bg-blue-600' : 'bg-orange-500'), title: !sOk ? '反潮警報' : (can ? '建議開窗' : '建議關窗'),
                             items: [{ label: '防反潮 (外溫>內露)', val: outdoor.t, pass: sOk }, { label: '物理排濕 (外露<內露)', val: outdoorDP, pass: dOk }] };
                }
            }, [indoorDP, outdoor, outdoorDP, algo]);

            return (
                <div className="bg-white min-h-screen md:min-h-0 md:rounded-[2.5rem] shadow-2xl flex flex-col overflow-hidden font-sans border border-slate-200">
                    <header className="bg-slate-900 text-white p-6 flex justify-between items-center">
                        <div className="flex items-center gap-3"><Icon name="Wind" className="text-emerald-400" /><h1 className="text-xl font-black">開窗判斷助手</h1></div>
                        <button onClick={refreshData} className="p-2 hover:bg-white/10 rounded-full transition-all"><Icon name="RefreshCw" className={outdoor.loading ? 'animate-spin' : ''} /></button>
                    </header>

                    <main className="p-4 space-y-4 flex-1 overflow-y-auto">
                        <div className="flex bg-slate-100 p-1 rounded-2xl">
                            <button onClick={()=>setAlgo('strict')} className={`flex-1 py-3 rounded-xl text-xs font-black ${algo==='strict'?'bg-white shadow text-slate-800':'text-slate-400'}`}>嚴格強效除濕</button>
                            <button onClick={()=>setAlgo('standard')} className={`flex-1 py-3 rounded-xl text-xs font-black ${algo==='standard'?'bg-white shadow text-slate-800':'text-slate-400'}`}>一般物理防潮</button>
                        </div>

                        <section className="bg-slate-50 p-4 rounded-2xl border">
                            <div className="flex justify-between items-center mb-3 text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                                <span className="flex items-center gap-1"><Icon name="Globe" className="w-3 h-3"/> 戶外測站 (CWA)</span>
                                <span className="bg-slate-200 px-2 py-0.5 rounded text-slate-500">{outdoor.station || '定位中...'}</span>
                            </div>
                            <div className="grid grid-cols-2 gap-2 mb-4">
                                <select value={city} onChange={e=>{setCity(e.target.value); setDist(TAIWAN_DATA[e.target.value][0])}} className="bg-white border p-3 rounded-xl text-sm font-bold outline-none">
                                    {Object.keys(TAIWAN_DATA).map(c=><option key={c} value={c}>{c}</option>)}
                                </select>
                                <select value={dist} onChange={e=>setDist(e.target.value)} className="bg-white border p-3 rounded-xl text-sm font-bold outline-none">
                                    {TAIWAN_DATA[city].map(d=><option key={d} value={d}>{d}</option>)}
                                </select>
                            </div>
                            <div className="grid grid-cols-3 gap-2">
                                <DataCard label="溫度" value={outdoor.t} unit="°" />
                                <DataCard label="濕度" value={outdoor.h} unit="%" />
                                <DataCard label="露點" value={outdoorDP} unit="°" highlight />
                            </div>
                        </section>

                        {/* 方案 B: 室內數據整合 */}
                        <section className="bg-slate-50 p-4 rounded-2xl border">
                            <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest flex items-center gap-1 mb-3"><Icon name="Thermometer" className="w-3 h-3"/> 室內環境 (Indoor)</label>
                            <div className="grid grid-cols-3 gap-2">
                                <div className="bg-white p-2 rounded-2xl border shadow-sm">
                                    <div className="text-[9px] text-slate-400 font-bold mb-1 text-center">溫度 °C</div>
                                    <input type="number" step="0.1" value={indoor.t} onChange={e=>setIndoor({...indoor, t: e.target.value})} className="w-full text-center text-lg font-black bg-transparent outline-none" />
                                </div>
                                <div className="bg-white p-2 rounded-2xl border shadow-sm">
                                    <div className="text-[9px] text-slate-400 font-bold mb-1 text-center">濕度 %</div>
                                    <input type="number" step="1" value={indoor.h} onChange={e=>setIndoor({...indoor, h: e.target.value})} className="w-full text-center text-lg font-black bg-transparent outline-none" />
                                </div>
                                <div className="bg-indigo-50 p-2 rounded-2xl border border-indigo-100 shadow-sm text-center">
                                    <div className="text-[9px] text-indigo-600 font-bold mb-1">室內露點</div>
                                    <div className="text-lg text-indigo-600 font-black">{indoorDP ?? '--'}°</div>
                                </div>
                            </div>
                        </section>

                        {analysis && (
                            <section className={`${analysis.color} p-6 rounded-[2.5rem] text-white shadow-2xl transition-all duration-500`}>
                                <div className="flex items-center gap-4 mb-4">
                                    <Icon name={analysis.color==='bg-emerald-600'?'Check':'X'} className="w-8 h-8" />
                                    <h2 className="text-3xl font-black">{analysis.title}</h2>
                                </div>
                                <div className="space-y-2">
                                    {analysis.items.map((item, i) => (
                                        <div key={i} className="bg-black/10 rounded-2xl p-4 flex justify-between items-center border border-white/10">
                                            <div><div className="text-[10px] font-bold opacity-60 uppercase mb-1">{item.label}</div><div className="text-2xl font-mono font-black">{item.val}</div></div>
                                            <Icon name={item.pass ? "Check" : "X"} className={item.pass ? 'text-emerald-300' : 'text-red-300'} />
                                        </div>
                                    ))}
                                </div>
                            </section>
                        )}
                    </main>
                </div>
            );
        }

        const DataCard = ({ label, value, unit, highlight }) => (
            <div className={`p-3 rounded-2xl text-center border ${highlight ? 'bg-emerald-600 text-white border-emerald-500' : 'bg-white border-slate-100 shadow-sm'}`}>
                <div className={`text-[10px] font-bold mb-1 ${highlight ? 'text-emerald-100' : 'text-slate-400'}`}>{label}</div>
                <div className="text-lg font-black">{value ?? '--'}<span className="text-[10px] ml-0.5 font-normal">{unit}</span></div>
            </div>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
